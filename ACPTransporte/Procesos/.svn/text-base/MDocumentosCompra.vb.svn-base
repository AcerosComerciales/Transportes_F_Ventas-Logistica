Imports ACFramework

Imports ACBTransporte
Imports ACETransporte
Imports ACBVentas
Imports ACEVentas
Imports C1.Win.C1FlexGrid

Public Class MDocumentosCompra
#Region " Variables "
   Private managerEntidades As BEntidades
   Private managerTRAN_Documentos As BTRAN_Documentos

   Private bs_tipodocumento As BindingSource
   Private bs_moneda As BindingSource

   Private bs_documentos As BindingSource
   Private bs_documentosdetalle As BindingSource
   Private m_listBindHelper As List(Of ACBindHelper)

   Private m_modArticulo As Boolean = False
   Private m_tran_piezas As ETRAN_Piezas

   Enum TPiezas
      Codigo = 0
      Nombre = 1
   End Enum

   Enum TInicio
      Normal
      Busqueda
   End Enum

#End Region

#Region " Propiedades "
   Public ReadOnly Property TRAN_Documentos() As ETRAN_Documentos
      Get
         Return managerTRAN_Documentos.TRAN_Documentos
      End Get
   End Property

#End Region

#Region " Constructores "
   Public Sub New(ByVal x_icono As System.Drawing.Bitmap, ByVal x_inicio As TInicio)

      ' This call is required by the designer.
      InitializeComponent()

      ' Add any initialization after the InitializeComponent() call.
      Try
         tabMantenimiento.HideTabsMode = Crownwood.DotNetMagic.Controls.HideTabsModes.HideAlways
         tabMantenimiento.SelectedTab = tabBusqueda

         managerTRAN_Documentos = New BTRAN_Documentos
         managerEntidades = New BEntidades

         cargarCombos()
         formatearGrilla()

         If Not IsNothing(x_icono) Then Me.Icon = Icon.FromHandle(x_icono.GetHicon)
         chkPrecIGV.Enabled = False
         acTool.ACBtnSalirVisible = True
         Select Case x_inicio
            Case TInicio.Normal
               actsbtnSeleccionar.Visible = False
            Case TInicio.Busqueda
               acTool.ACTipoToolBar = ACControles.ACToolBarMantHorizontalNew.tipoToolBar.ToolSalir
               actsbtnSeleccionar.Visible = True
         End Select
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), Colecciones.getError("00000"), ex)
      End Try
   End Sub
#End Region

#Region " Metodos "

   Private Sub cargarCombos()
      Try

         '' Tipo de Documento Comprobante
         bs_tipodocumento = New BindingSource
         bs_tipodocumento.DataSource = Colecciones.TiposDocCompFacturacion()
         ACUtilitarios.ACCargaCombo(cmbDocumento, bs_tipodocumento, "TIPOS_Descripcion", "TIPOS_Codigo")
         '' Moneda
         bs_moneda = New BindingSource() : bs_moneda.DataSource = Colecciones.Tipos(ETipos.MyTipos.TipoMoneda)
         ACUtilitarios.ACCargaCombo(cmbMoneda, bs_moneda, "TIPOS_DescCorta", "TIPOS_Codigo")

      Catch ex As Exception
         Throw ex
      End Try
   End Sub

   Private Sub formatearGrilla()
      Dim index As Integer = 1
      Try
         ACFrameworkC1.ACUtilitarios.ACFormatearGrilla(c1grdBusqueda, 1, 1, 10, 1, 1)
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Codigo", "Codigo", "Codigo", 150, True, False, "System.String") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Fecha", "DOCUS_Fecha", "DOCUS_Fecha", 150, True, False, "System.DateTime") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Documento", "Documento", "Documento", 150, True, False, "System.String") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "RUC", "ENTID_Codigo", "ENTID_Codigo", 150, True, False, "System.String") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Razon Social", "ENTID_RazonSocial", "ENTID_RazonSocial", 150, True, False, "System.String") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Importe", "DOCUS_Importe", "DOCUS_Importe", 110, True, False, "System.Decimal", Parametros.GetParametro(EParametros.TipoParametros.pg_FMondo4d)) : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "IGV", "DOCUS_ImporteIGV", "DOCUS_ImporteIGV", 110, True, False, "System.Decimal", Parametros.GetParametro(EParametros.TipoParametros.pg_FMondo4d)) : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Total", "DOCUS_TotalPago", "DOCUS_TotalPago", 110, True, False, "System.Decimal", Parametros.GetParametro(EParametros.TipoParametros.pg_FMondo4d)) : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Estado", "DOCUS_Estado", "DOCUS_Estado", 150, True, False, "System.String") : index += 1

         c1grdBusqueda.AllowEditing = False
         c1grdBusqueda.Styles.Alternate.BackColor = Color.LightGray
         c1grdBusqueda.Styles.Fixed.TextAlign = TextAlignEnum.CenterCenter
         c1grdBusqueda.Styles.Highlight.BackColor = Color.Gray
         c1grdBusqueda.SelectionMode = SelectionModeEnum.Row
         c1grdBusqueda.AllowSorting = AllowSortingEnum.SingleColumn
         c1grdBusqueda.AllowResizing = AllowResizingEnum.Columns

         Dim t As C1.Win.C1FlexGrid.CellStyle = c1grdBusqueda.Styles.Add("Facturado")
         t.BackColor = Color.LightGreen
         t.ForeColor = Color.DarkBlue
         t.Font = New Font(c1grdBusqueda.Font, FontStyle.Regular)

         Dim t1 As C1.Win.C1FlexGrid.CellStyle = c1grdBusqueda.Styles.Add("Rehuzado")
         t1.BackColor = Color.LightSalmon
         t1.ForeColor = Color.DarkBlue
         t1.Font = New Font(c1grdBusqueda.Font, FontStyle.Regular)

         Dim u As C1.Win.C1FlexGrid.CellStyle = c1grdBusqueda.Styles.Add("Facturar")
         u.BackColor = Color.Green
         u.ForeColor = Color.White
         u.Font = New Font(c1grdBusqueda.Font, FontStyle.Regular)

         Dim d As C1.Win.C1FlexGrid.CellStyle = c1grdBusqueda.Styles.Add("Anulado")
         d.BackColor = Color.Red
         d.ForeColor = Color.White
         d.Font = New Font(c1grdBusqueda.Font, FontStyle.Bold)
         c1grdBusqueda.DrawMode = C1.Win.C1FlexGrid.DrawModeEnum.OwnerDraw

         index = 1
         ACFrameworkC1.ACUtilitarios.ACFormatearGrilla(c1grdDetalle, 1, 1, 7, 1, 0)
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdDetalle, index, "Item", "DCDET_Item", "DCDET_Item", 110, True, False, "System.String") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdDetalle, index, "Codigo", "PIEZA_Id", "PIEZA_Id", 110, True, False, "System.Integer") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdDetalle, index, "Cantidad", "DCDET_Cantidad", "DCDET_Cantidad", 110, True, False, "System.Decimal", Parametros.GetParametro(EParametros.TipoParametros.pg_FMondo2d)) : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdDetalle, index, "Descripción", "DCDET_Descripcion", "DCDET_Descripcion", 90, True, False, "System.String") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdDetalle, index, "Precio", "DCDET_Importe", "DCDET_Importe", 110, True, False, "System.Decimal", Parametros.GetParametro(EParametros.TipoParametros.pg_FMondo4d)) : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdDetalle, index, "Sub-Importe", "DCDET_SubImporte", "DCDET_SubImporte", 100, True, False, "System.Decimal", Parametros.GetParametro(EParametros.TipoParametros.pg_FMondo4d)) : index += 1


         c1grdDetalle.AllowEditing = False
         c1grdDetalle.AutoResize = True
         c1grdDetalle.Cols(0).Width = 18
         c1grdDetalle.Styles.Alternate.BackColor = Color.LightGray
         c1grdDetalle.Styles.Fixed.TextAlign = TextAlignEnum.CenterCenter
         c1grdDetalle.Styles.Highlight.BackColor = Color.Gray
         c1grdDetalle.SelectionMode = SelectionModeEnum.Row
         c1grdDetalle.AllowResizing = AllowResizingEnum.None

      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Text), "No se puede dar formato a la grilla", ex)
      End Try
   End Sub

   Private Sub AsignarBinding()
      Try
         m_listBindHelper = New List(Of ACBindHelper)
         m_listBindHelper.Add(ACBindHelper.ACBind(actxaNroDocProveedor, "Text", managerTRAN_Documentos.TRAN_Documentos, "ENTID_Codigo"))
         m_listBindHelper.Add(ACBindHelper.ACBind(cmbMoneda, "SelectedValue", managerTRAN_Documentos.TRAN_Documentos, "TIPOS_CodTipoMoneda"))
         m_listBindHelper.Add(ACBindHelper.ACBind(cmbDocumento, "SelectedValue", managerTRAN_Documentos.TRAN_Documentos, "TIPOS_CodTipoDocumento"))
         m_listBindHelper.Add(ACBindHelper.ACBind(txtSerie, "Text", managerTRAN_Documentos.TRAN_Documentos, "DOCUS_Serie"))
         m_listBindHelper.Add(ACBindHelper.ACBind(actxnNumero, "Text", managerTRAN_Documentos.TRAN_Documentos, "DOCUS_Numero"))
         m_listBindHelper.Add(ACBindHelper.ACBind(actxnImporte, "Text", managerTRAN_Documentos.TRAN_Documentos, "DOCUS_Importe"))
         m_listBindHelper.Add(ACBindHelper.ACBind(actxnIGV, "Text", managerTRAN_Documentos.TRAN_Documentos, "DOCUS_ImporteIGV"))
         m_listBindHelper.Add(ACBindHelper.ACBind(actxnTotalPagar, "Text", managerTRAN_Documentos.TRAN_Documentos, "DOCUS_TotalPago"))
         'm_listBindHelper.Add(ACBindHelper.ACBind(actxaNroDocProveedor, "Text", managerTRAN_Documentos.TRAN_Documentos, "ENTID_Codigo"))
         If managerTRAN_Documentos.TRAN_Documentos.DOCUS_Fecha.Year < 1700 Then managerTRAN_Documentos.TRAN_Documentos.DOCUS_Fecha = DateTime.Now
         m_listBindHelper.Add(ACBindHelper.ACBind(dtpFecEmision, "Value", managerTRAN_Documentos.TRAN_Documentos, "DOCUS_Fecha"))
         If managerTRAN_Documentos.TRAN_Documentos.DOCUS_FechaIngreso.Year < 1700 Then managerTRAN_Documentos.TRAN_Documentos.DOCUS_FechaIngreso = DateTime.Now
         m_listBindHelper.Add(ACBindHelper.ACBind(dtpFecIngreso, "Value", managerTRAN_Documentos.TRAN_Documentos, "DOCUS_FechaIngreso"))

      Catch ex As Exception
         Throw ex
      End Try
   End Sub

   Private Sub setInstancia(ByVal _opcion As ACUtilitarios.ACSetInstancia)
      actsbtnSeleccionar.Visible = False
      Select Case _opcion
         Case ACUtilitarios.ACSetInstancia.Nuevo
            AddHandler actxnPrecIGV.LostFocus, AddressOf actxnProdCantidad_LostFocus
            AddHandler actxnProdCantidad.LostFocus, AddressOf actxnProdCantidad_LostFocus
            AddHandler actxnDescuento.LostFocus, AddressOf actxnProdCantidad_LostFocus
            AddHandler actxnPrecio.LostFocus, AddressOf actxnPrecio_LostFocus
            AddHandler chkPrecIGV.LostFocus, AddressOf actxnPrecio_LostFocus

            AddHandler c1grdDetalle.KeyDown, AddressOf c1grdDetalle_KeyDown

            ACUtilitarios.ACLimpiaVar(pnlCabecera)
            ACUtilitarios.ACLimpiaVar(pnlItem)
            ACUtilitarios.ACLimpiaVar(pnlPie)
            tabMantenimiento.SelectedTab = tabDatos
         Case ACUtilitarios.ACSetInstancia.Modificado
            pnlItem.Enabled = True
            c1grdDetalle.Focus()
            actsbtnSeleccionar.Visible = True
            actsbtnSeleccionar.Visible = False
            'm_modificar = True
            'AddHandler c1grdDetalle.KeyDown, AddressOf c1grdDetalle_KeyDown
         Case ACUtilitarios.ACSetInstancia.Guardar
            txtBusqueda.Focus()
            actsbtnSeleccionar.Visible = True
            tabMantenimiento.SelectedTab = tabBusqueda
            'm_modificar = False
            'RemoveHandler c1grdDetalle.KeyDown, AddressOf c1grdDetalle_KeyDown
         Case ACUtilitarios.ACSetInstancia.Deshacer
            tabMantenimiento.SelectedTab = tabBusqueda
            actsbtnSeleccionar.Visible = True
            acTool.ACBtnImprimirVisible = False
            acTool.ACBtnAnularVisible = False
            acTool.ACBtnRehusarVisible = False

            c1grdDetalle.Enabled = True

            Me.KeyPreview = False
            RemoveHandler actxnPrecIGV.LostFocus, AddressOf actxnProdCantidad_LostFocus
            RemoveHandler actxnProdCantidad.LostFocus, AddressOf actxnProdCantidad_LostFocus
            RemoveHandler actxnDescuento.LostFocus, AddressOf actxnProdCantidad_LostFocus
            RemoveHandler actxnPrecio.LostFocus, AddressOf actxnPrecio_LostFocus
            RemoveHandler chkPrecIGV.LostFocus, AddressOf actxnPrecio_LostFocus

            RemoveHandler c1grdDetalle.KeyDown, AddressOf c1grdDetalle_KeyDown
            'm_modificar = False
            'RemoveHandler c1grdDetalle.KeyDown, AddressOf c1grdDetalle_KeyDown
         Case ACUtilitarios.ACSetInstancia.Previsualizar

      End Select
   End Sub

   Private Sub NuevaEntidad(ByVal x_entid_nrodocumento As String, ByVal x_tipoentidad As EEntidades.TipoEntidad)
      Try
         Dim frmEntidad As New MEntidad(MEntidad.Inicio.NuevaEntidad, x_tipoentidad)
         frmEntidad.StartPosition = FormStartPosition.CenterScreen
         If x_entid_nrodocumento.Length > 0 Then
            frmEntidad.EEntidad.ENTID_NroDocumento = x_entid_nrodocumento
            frmEntidad.lblNombres.Focus()
         End If
         If frmEntidad.ShowDialog() = Windows.Forms.DialogResult.OK Then
            Select Case x_tipoentidad
               Case EEntidades.TipoEntidad.Proveedores
                  If managerEntidades.Cargar(frmEntidad.EEntidad.ENTID_Codigo, EEntidades.TipoInicializacion.Direcciones) Then
                     actxaNroDocProveedor.Text = managerEntidades.Entidades.ENTID_NroDocumento
                     actxaDescProveedor.Text = managerEntidades.Entidades.ENTID_RazonSocial
                  End If
            End Select
         End If
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), String.Format("Ocurrio un error en el proceso Nuevo ", x_tipoentidad.ToString()), ex)
      End Try
   End Sub

   Private Sub AyudaEntidad(ByVal x_cadenas As String, ByVal x_campo As String, ByVal x_opcion As EEntidades.TipoEntidad)
      Try
         Select Case x_opcion
            Case EEntidades.TipoEntidad.Proveedores
               Dim _where As New Hashtable
               _where.Add(x_campo, New ACWhere(x_cadenas, ACWhere.TipoWhere._Like))
               If managerEntidades.Ayuda(_where, x_opcion) Then
                  Dim Ayuda As New ACControlesC1.ACAyudaFlex("Buscar Cliente", managerEntidades.DTEntidades, False)
                  If Ayuda.ShowDialog() = Windows.Forms.DialogResult.OK Then
                     '' Cargar datos del cliente
                     actxaNroDocProveedor.Text = Ayuda.Respuesta.Rows(0)("Doc./R.U.C.")
                     actxaDescProveedor.Text = Ayuda.Respuesta.Rows(0)("Razon Social")
                  End If
               Else
                  ACControles.ACDialogos.ACMostrarMensajeInformacion(String.Format("Información: {0}", Me.Text), "No se puede Cargar la ayuda por que no se encontro registros")
               End If
         End Select
      Catch ex As Exception
         Throw ex
      End Try
   End Sub

   Private Sub _KeyUp(ByVal sender As System.Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles MyBase.KeyUp
      If e.KeyCode = Keys.Enter Then
         'If sender.Name = "txtBusqueda" Then
         '   Exit Sub
         'End If
         'If TypeOf ActiveControl Is ACControles.ACTextBoxAyuda And ActiveControl.Name = "actxaProdCodigo" Then
         '   Exit Sub
         'End If
         SendKeys.Send("{TAB}")
      End If
   End Sub

   Private Function addDetallePedido() As Boolean
      Try
         Dim _detDocumentos As New ETRAN_DocumentosDetalle
         _detDocumentos.Instanciar(ACEInstancia.Nuevo)
         _detDocumentos.PIEZA_Id = m_tran_piezas.PIEZA_Id
         _detDocumentos.PIEZA_Codigo = actxaProdCodigo.Text
         _detDocumentos.DCDET_Descripcion = actxaDescripcion.Text
         _detDocumentos.DCDET_Precio = actxnPrecio.Text
         _detDocumentos.DCDET_Importe = actxnPrecIGV.Text
         _detDocumentos.DCDET_Descuento = actxnDescuento.Text
         _detDocumentos.DCDET_SubImporte = actxnSubImporte.Text
         _detDocumentos.DCDET_Cantidad = actxnProdCantidad.Text
         managerTRAN_Documentos.TRAN_Documentos.ListETRAN_DocumentosDetalle.Add(_detDocumentos)
         calcular()
         setProducto(False)
         bs_documentosdetalle.ResetBindings(False)
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Private Sub ModificarArticulo()
      Try
         CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).PIEZA_Codigo = actxaProdCodigo.Text
         CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).PIEZA_Id = m_tran_piezas.PIEZA_Id
         CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).DCDET_Descripcion = actxaDescripcion.Text
         CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).DCDET_Precio = actxnPrecio.Text
         CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).DCDET_IncGV = chkPrecIGV.Checked
         CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).DCDET_Importe = actxnPrecIGV.Text
         CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).DCDET_SubImporte = actxnSubImporte.Text
         setProducto(False)
         calcular()
         c1grdDetalle.Enabled = True
         Me.KeyPreview = False
         m_modArticulo = False
      Catch ex As Exception
         Throw ex
      End Try
   End Sub

   Private Sub setProducto(ByVal x_opcion As Boolean)
      Try
         If x_opcion Then

         Else
            actxaProdCodigo.Clear()
            actxaDescripcion.Clear()
            actxnProdCantidad.Text = "0.00"
            actxnDescuento.Text = "0.00"
            actxnPrecio.Text = "0.00"
            actxnPrecIGV.Text = "0.00"
            actxnSubImporte.Text = "0.00"
            m_tran_piezas = Nothing
         End If
      Catch ex As Exception
         Throw ex
      End Try
   End Sub

   Private Sub calcular(Optional ByVal x_moneda As Boolean = False)
      Try
         Dim _total As Decimal = 0
         For Each item As ETRAN_DocumentosDetalle In managerTRAN_Documentos.TRAN_Documentos.ListETRAN_DocumentosDetalle
            _total += item.DCDET_SubImporte
         Next
         Dim _igv As Decimal = Parametros.GetParametro(EParametros.TipoParametros.PIGV)
         Dim _subimporte As Decimal = Math.Round(_total / ((100 + _igv) / 100), 2)
         actxnTotalPagar.Text = _total : actxnTotalPagar.Formatear()
         actxnImporte.Text = _subimporte : actxnImporte.Formatear()
         actxnIGV.Text = _total - _subimporte : actxnIGV.Formatear()

      Catch ex As Exception
         Throw ex
      End Try
   End Sub

   Private Function getOpcion() As Integer
      If rbtnProveedor.Checked Then
         Return 0
      ElseIf rbtnNroDocumento.Checked Then
         Return 1
      Else
         Return 0
      End If
   End Function

   Private Sub CargarParte(ByVal x_opcion As TPiezas, ByVal x_cadena As String)
      Try
         Dim m_piezas As New BTRAN_Piezas

         If m_piezas.Ayuda(x_opcion, x_cadena) Then
            Dim Ayuda As New ACControlesC1.ACAyudaFlex("Buscar Proveedor", m_piezas.Datos.Tables(0), False)
            If Ayuda.ShowDialog() = Windows.Forms.DialogResult.OK Then
               '' Cargar datos del cliente
               actxaProdCodigo.Text = Ayuda.Respuesta.Rows(0)("Codigo")
               actxaDescripcion.Text = Ayuda.Respuesta.Rows(0)("Descripcion")
               m_tran_piezas = New ETRAN_Piezas
               m_tran_piezas.PIEZA_Id = Ayuda.Respuesta.Rows(0)("Id")
               m_tran_piezas.PIEZA_Codigo = Ayuda.Respuesta.Rows(0)("Codigo")
               m_tran_piezas.PIEZA_Descripcion = Ayuda.Respuesta.Rows(0)("Descripcion")
            End If
         Else
            ACControles.ACDialogos.ACMostrarMensajeInformacion(String.Format("Información: {0}", Me.Text), "No se puede Cargar la ayuda por que no se encontro registros")
         End If
         Me.KeyPreview = True
      Catch ex As Exception
         Throw ex
      End Try
   End Sub

   Private Sub subirItem()
      Try
         actxaProdCodigo.Text = CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).PIEZA_Codigo
         actxnProdCantidad.Text = CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).DCDET_Cantidad
         actxaDescripcion.Text = CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).DCDET_Descripcion
         actxnPrecio.Text = CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).DCDET_Precio
         chkPrecIGV.Checked = CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).DCDET_IncGV
         actxnPrecIGV.Text = CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).DCDET_Importe
         m_tran_piezas.PIEZA_Id = CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).PIEZA_Id
         m_tran_piezas.PIEZA_Codigo = CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).PIEZA_Codigo
         m_tran_piezas.PIEZA_Descripcion = CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).DCDET_Descripcion
         
      Catch ex As Exception
         Throw ex
      End Try
   End Sub
#End Region

#Region " Metodos de Controles"


   Private Sub actxaNroDocProveedor_ACAyudaClick(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles actxaNroDocProveedor.ACAyudaClick
      Try
         AyudaEntidad(actxaNroDocProveedor.Text, "ENTID_NroDocumento", EEntidades.TipoEntidad.Proveedores)
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), "Ocurrio un error en el proceso cargar Cliente", ex)
      End Try
   End Sub

   Private Sub actxaDescProveedor_ACAyudaClick(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles actxaDescProveedor.ACAyudaClick
      Try
         AyudaEntidad(actxaDescProveedor.Text, "ENTID_RazonSocial", EEntidades.TipoEntidad.Proveedores)
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), "Ocurrio un error en el proceso cargar Cliente", ex)
      End Try
   End Sub

   Private Sub actxaNroDocProveedor_KeyDown(ByVal sender As System.Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles actxaNroDocProveedor.KeyDown
      Try
         If e.KeyData = Keys.Enter Then
            If actxaNroDocProveedor.Text.ToString().Length >= ACETransporte.Constantes.LongitudCodigo Then
               '' Cargar datos adicionales cliente
               If actxaNroDocProveedor.ACAyuda.Enabled = True Then
                  If managerEntidades.CargarDocIden(actxaNroDocProveedor.Text, EEntidades.TipoInicializacion.Direcciones) Then
                     actxaNroDocProveedor.Text = managerEntidades.Entidades.ENTID_NroDocumento
                     actxaDescProveedor.Text = managerEntidades.Entidades.ENTID_RazonSocial
                     lblMoneda.Focus()
                  Else
                     If ACControles.ACDialogos.ACMostrarMensajePregunta(String.Format("Documento de Identidad: {0}", Me.Text) _
                                     , String.Format("El Documento de Identidad {0} no existe, ¿Desea Ingresar la Entidad?", actxaNroDocProveedor.Text) _
                                     , ACControles.ACDialogos.LabelBotom.Si_No) = DialogResult.Yes Then
                        NuevaEntidad(actxaNroDocProveedor.Text, EEntidades.TipoEntidad.Proveedores)
                     Else
                        actxaNroDocProveedor.Clear()
                        actxaDescProveedor.Clear()
                        lblProveedor.Focus()
                     End If
                  End If
               End If
            Else
               If actxaNroDocProveedor.Text.Trim().Length > 0 Then
                  ACControles.ACDialogos.ACMostrarMensajeInformacion(String.Format("Información: {0}", Me.Text), String.Format("El Documento de Identidad {0} no existe, el documento ingresado tienen menos de 8 numeros", actxaNroDocProveedor.Text))
                  actxaNroDocProveedor.Clear()
                  actxaDescProveedor.Clear()
                  lblProveedor.Focus()
               End If

            End If
         End If
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), "Ocurrio un error en el proceso Cargar Cliente", ex)
      End Try
   End Sub

   Private Sub txtOpcion_KeyDown(ByVal sender As System.Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles txtOpcion.KeyDown
      Try
         Select Case e.KeyData
            Case Keys.Enter
               'If Not m_modArticulo Then
               '   If managerGenerarCotizacion.VENT_Pedidos.ListDetPedidos.Count >= CType(bs_tipodocumento.Current, ETipos).TIPOS_Items Then
               '      ACControles.ACDialogos.ACMostrarMensajeInformacion(String.Format("Información: {0}", Me.Text), String.Format("No puede agregar mas articulos para este tipo de documento {0}", cmbDocumento.Text))
               '      Return
               '   End If
               '   addDetallePedido()
               '   setProducto(False)
               '   m_modArticulo = False
               '   pnlDetProductos.Focus()
               'Else
               '   ModificarArticulo()
               '   Label2.Focus()
               'End If
               c1grdDetalle.AutoSizeCols()
               Me.KeyPreview = True
            Case Keys.Escape
               setProducto(False)
               c1grdDetalle.Enabled = True
               'cmbPrecioUnitario.Enabled = False
               'Me.KeyPreview = False
               'm_modArticulo = False
               'c1grdDetalle.AutoSizeCols()
            Case Keys.Left
               actxnSubImporte.Focus()
            Case Keys.Right
               actxaProdCodigo.Focus()
            Case Else

         End Select
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Text), "No se puede procesar", ex)
      End Try
   End Sub

   Private Sub txtOpcion_KeyPress(ByVal sender As System.Object, ByVal e As System.Windows.Forms.KeyPressEventArgs) Handles txtOpcion.KeyPress
      Try
         Select Case e.KeyChar
            Case "+"c
               If m_modArticulo Then
                  e.Handled = True
                  ModificarArticulo()
                  c1grdDetalle.AutoSizeCols()
               Else
                  e.Handled = True
                  If addDetallePedido() Then
                     actxaProdCodigo.Focus()
                     txtOpcion.Text = ""
                     txtOpcion.SelectAll()
                     setProducto(False)
                  End If
               End If
               c1grdDetalle.AutoSizeCols()
               lblCodigo.Focus()
            Case "-"c
               e.Handled = True
               c1grdDetalle.AutoSizeCols()
            Case Else
               e.Handled = True
         End Select
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), "Ocurrio un error en el proceso opciones", ex)
      End Try
   End Sub

   Private Sub c1grdDetalle_Enter(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles c1grdDetalle.Enter
      Me.KeyPreview = False
   End Sub

   Private Sub btnConsultar_Click(sender As Object, e As EventArgs) Handles btnConsultar.Click
      Try
         bs_documentos = New BindingSource
         If Not managerTRAN_Documentos.TRAN_ObtenerDocumentosCompra(AcFecha.ACDtpFecha_De.Value.Date, AcFecha.ACDtpFecha_A.Value.Date, GApp.PuntoVenta, _
                                                                getOpcion(), txtBusqueda.Text, chkTodos.Checked) Then
            managerTRAN_Documentos.ListTRAN_Documentos = New List(Of ACETransporte.ETRAN_Documentos)
         End If
         bs_documentos.DataSource = managerTRAN_Documentos.ListTRAN_Documentos
         c1grdBusqueda.DataSource = bs_documentos
         bnavBusqueda.BindingSource = bs_documentos

      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), String.Format(Colecciones.getError("00101"), "Buscando Documentos"), ex)
      End Try
   End Sub

   Private Sub acTool_ACBtnSalir_Click(sender As Object, e As EventArgs) Handles acTool.ACBtnSalir_Click

   End Sub

   Private Sub actxaProdCodigo_ACAyudaClick(sender As Object, e As EventArgs) Handles actxaProdCodigo.ACAyudaClick
      CargarParte(TPiezas.Codigo, actxaProdCodigo.Text)
   End Sub

   Private Sub actxaDescripcion_ACAyudaClick(sender As Object, e As EventArgs) Handles actxaDescripcion.ACAyudaClick
      CargarParte(TPiezas.Nombre, actxaDescripcion.Text)
   End Sub

   Private Sub c1grdDetalle_KeyDown(ByVal sender As System.Object, ByVal e As System.Windows.Forms.KeyEventArgs)
      Try
         e.SuppressKeyPress = True
         Select Case e.KeyCode
            Case Keys.Enter
               subirItem()
               c1grdDetalle.Enabled = False
               actxnProdCantidad.Focus()
               m_modArticulo = True
               Me.KeyPreview = True
            Case Keys.Delete
               If ACControles.ACDialogos.ACMostrarMensajePregunta(String.Format("Quitar Registro: {0}", Me.Text) _
             , String.Format("Desea quitar el Articulo : {0} ", CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle).DCDET_Descripcion) _
             , ACControles.ACDialogos.LabelBotom.Si_No) = DialogResult.Yes Then
                  Dim m_det As ETRAN_DocumentosDetalle = CType(bs_documentosdetalle.Current, ETRAN_DocumentosDetalle)
                  managerTRAN_Documentos.TRAN_Documentos.ListETRAN_DocumentosDetalle.Remove(m_det)
                  bs_documentosdetalle.ResetBindings(False)
                  calcular()
               End If
            Case Else
               e.Handled = False
         End Select
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Text), "No se puede calcular carga el Item", ex)
      End Try
   End Sub


   Private Sub actxnPrecio_LostFocus(ByVal sender As System.Object, ByVal e As System.EventArgs)
      Try
         Dim _precio As Decimal = CType(actxnPrecio.Text, Decimal)
         Dim _igv As Decimal = Parametros.GetParametro(EParametros.TipoParametros.PIGV)
         If chkPrecIGV.Checked Then
            actxnPrecIGV.Text = _precio * (100 + _igv) / 100
         Else
            actxnPrecIGV.Text = _precio
         End If
         actxnPrecIGV.Formatear()
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Convert.ToString(Text)), "No se puede calcular el Precio", ex)
      End Try
   End Sub

   Private Sub actxnProdCantidad_LostFocus(ByVal sender As System.Object, ByVal e As System.EventArgs)
      Try
         Me.KeyPreview = True
         Dim _cantidad As Decimal
         Dim _descuento As Decimal
         Try
            _cantidad = CType(actxnProdCantidad.Text, Decimal)
            _descuento = CType(actxnDescuento.Text, Decimal)

         Catch ex As Exception
            _cantidad = 0
         End Try
         Dim _igv As Decimal = Parametros.GetParametro(EParametros.TipoParametros.PIGV)
         If _cantidad > 0 Then

            Dim _precioUnitario As Double
            Try
               _precioUnitario = CType(actxnPrecio.Text, Decimal)

            Catch ex As Exception
               _precioUnitario = 0
            End Try
            Dim _total As Double = _cantidad * _precioUnitario * ((100 - _descuento) / 100)
            If chkIncluidoIGV.Checked Then
               actxnSubImporte.Text = (_total * (100 + _igv) / 100).ToString(Parametros.GetParametro(EParametros.TipoParametros.pg_FMondo2d))
            Else
               actxnSubImporte.Text = _total.ToString(Parametros.GetParametro(EParametros.TipoParametros.pg_FMondo2d))
            End If

         Else
            '   actxnProdCantidad.Focus()
            '  ACControles.ACDialogos.ACMostrarMensajeInformacion(String.Format("Información: {0}", Me.Text), "Es necesario que ingrese una cantidad mayor a 0")
         End If
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Convert.ToString(Text)), "No se puede calcular el Sub-Importe", ex)
      End Try
   End Sub

#Region " ToolBox "

   Private Sub acTool_ACBtnCancelar_Click(sender As Object, e As EventArgs) Handles acTool.ACBtnCancelar_Click
      Try
         setInstancia(ACUtilitarios.ACSetInstancia.Deshacer)
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), String.Format(Colecciones.getError("00101"), "Cancelar Operación"), ex)
      End Try
   End Sub

   Private Sub acTool_ACBtnGrabar_Click(sender As Object, e As EventArgs) Handles acTool.ACBtnGrabar_Click
      Dim _msg As String = ""
      Try
         If Validar(_msg) Then
            Dim _numero As Integer = actxnNumero.Text
            managerTRAN_Documentos.TRAN_Documentos.DOCUS_Codigo = String.Format("{0}{1}{2}", cmbDocumento.SelectedValue.ToString.Substring(3, 2), _
                                                                                txtSerie.Text.ToString.PadLeft(5, "0"), _numero.ToString.PadLeft(26, "0"))
            managerTRAN_Documentos.TRAN_Documentos.DOCUS_Estado = ACEVentas.Constantes.getEstado(ACEVentas.Constantes.Estado.Ingresado)
            If managerTRAN_Documentos.Guardar(GApp.Usuario, True, True) Then
               ACControles.ACDialogos.ACMostrarMensajeSatisfactorio(String.Format("Información: {0}", Me.Text), "Grabado satisfactoriamente")
               setInstancia(ACUtilitarios.ACSetInstancia.Deshacer)
            End If
         Else
            Throw New Exception("No se completo el proceso Grabar. " & _msg)
         End If
      Catch ex As Exception
         acTool.setInstancia(ACControles.ACToolBarMantHorizontalNew.TipoInstancia.Nuevo)
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), String.Format(Colecciones.getError("00101"), " Grabar Registro"), ex)
      End Try
   End Sub

   Private Sub acTool_ACBtnModificar_Click(sender As Object, e As EventArgs) Handles acTool.ACBtnModificar_Click
      Try
         If managerTRAN_Documentos.CargarDocumento(CType(bs_documentos.Current, ETRAN_Documentos).DOCUS_Codigo, CType(bs_documentos.Current, ETRAN_Documentos).ENTID_Codigo, True) Then
            setInstancia(ACUtilitarios.ACSetInstancia.Nuevo)
            AsignarBinding()
            actxaDescProveedor.Text = managerTRAN_Documentos.TRAN_Documentos.ENTID_Cliente
            bs_documentosdetalle = New BindingSource
            bs_documentosdetalle.DataSource = managerTRAN_Documentos.TRAN_Documentos.ListETRAN_DocumentosDetalle
            c1grdDetalle.DataSource = bs_documentosdetalle
            bnavProductos.BindingSource = bs_documentosdetalle
            Me.KeyPreview = True
            pnlPedSeparacion.Visible = True
            actxnImporteOld.Text = actxnImporte.Text
            actxnIGVOld.Text = actxnIGV.Text
            actxnTotalPagarOld.Text = actxnTotalPagar.Text
         Else
            Throw New Exception("No puede cargar el registro, intento otro")
         End If
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), String.Format(Colecciones.getError("00101"), "Modificar"), ex)
      End Try
   End Sub

   Private Sub acTool_ACBtnNuevo_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles acTool.ACBtnNuevo_Click
      Try
         setInstancia(ACUtilitarios.ACSetInstancia.Nuevo)
         '' Activar las opciones generales del teclado
         KeyPreview = True
         managerTRAN_Documentos.TRAN_Documentos = New ETRAN_Documentos
         managerTRAN_Documentos.TRAN_Documentos.Instanciar(ACEInstancia.Nuevo)
         managerTRAN_Documentos.TRAN_Documentos.ListETRAN_DocumentosDetalle = New List(Of ETRAN_DocumentosDetalle)
         AsignarBinding()
         bs_documentosdetalle = New BindingSource
         bs_documentosdetalle.DataSource = managerTRAN_Documentos.TRAN_Documentos.ListETRAN_DocumentosDetalle

         c1grdDetalle.DataSource = bs_documentosdetalle
         bnavProductos.BindingSource = bs_documentosdetalle
         pnlPedSeparacion.Visible = False
      Catch ex As Exception
         acTool.setInstancia(ACControles.ACToolBarMantHorizontalNew.TipoInstancia.Cancelar)
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), "Ocurrio un error en el proceso Nueva Cotización/Pedido", ex)
      End Try
   End Sub

#End Region
#End Region

   Private Function Validar(ByRef x_msg As String) As Boolean
      Try
         If Not ACUtilitarios.ACDatosOk(pnlCabecera, x_msg) Then
            Return False
         End If
         If Not managerTRAN_Documentos.TRAN_Documentos.ListETRAN_DocumentosDetalle.Count > 0 Then
            x_msg &= String.Format("{0}- No se ha ingresado ningun Item.", vbNewLine)
         End If
         Return Not x_msg.Length > 0
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Private Sub chkIncluidoIGV_CheckedChanged(sender As Object, e As EventArgs) Handles chkIncluidoIGV.CheckedChanged
      chkPrecIGV.Checked = chkIncluidoIGV.Checked
   End Sub

   Private Sub actsbtnSeleccionar_Click(sender As Object, e As EventArgs) Handles actsbtnSeleccionar.Click
      Try
         If Not IsNothing(bs_documentos.Current) Then
            If CType(bs_documentos.Current, ETRAN_Documentos).DOCUS_Estado <> ACEVentas.Constantes.getEstado(ACEVentas.Constantes.Estado.Anulado) Then
               managerTRAN_Documentos.TRAN_Documentos = CType(bs_documentos.Current, ETRAN_Documentos)
               Me.DialogResult = Windows.Forms.DialogResult.OK
               Me.Close()
            Else
               Throw New Exception("No se puede agregar un documento que fue anulado")
            End If
         Else
            Throw New Exception("No ha cargado ningun documento, vuelva a probar la busqueda e intente de nuevo")
         End If
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), String.Format(Colecciones.getError("00101"), "Seleccionar Documento de Compra"), ex)
      End Try
   End Sub
End Class