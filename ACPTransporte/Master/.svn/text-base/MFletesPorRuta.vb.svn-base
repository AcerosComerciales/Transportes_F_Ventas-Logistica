Imports ACBTransporte
Imports ACFramework
Imports ACBVentas
Imports C1.Win.C1FlexGrid

Public Class MFletesPorRuta
#Region " Variables "
   Private managerFletePorRuta As BTRAN_FletePorRuta
   Private managerEntidades As BEntidades
   Private managerTRAN_Rutas As BTRAN_Rutas

   Private m_listBindHelper As List(Of ACBindHelper)
   Private bs_bentidades As BindingSource
   Private m_perfil As ACEVentas.EEntidades.TipoEntidad
#End Region

#Region " Propiedades "

#End Region

#Region " Constructores "
   Public Sub New()

      ' This call is required by the designer.
      InitializeComponent()

      ' Add any initialization after the InitializeComponent() call.
      Try
         managerEntidades = New BEntidades
         managerFletePorRuta = New BTRAN_FletePorRuta
         managerTRAN_Rutas = New BTRAN_Rutas

         tabMantenimiento.HideTabsMode = Crownwood.DotNetMagic.Controls.HideTabsModes.HideAlways
         tabMantenimiento.SelectedTab = tabBusqueda

         formatearGrilla()
         setInstancia(ACUtilitarios.ACSetInstancia.Deshacer)

         txtBusqueda.ACActivarAyudaAuto = True
         txtBusqueda.ACLongitudAceptada = Parametros.GetParametro(ACEVentas.EParametros.TipoParametros.pg_LongTexAyuda)

         acTool.ACBtnNuevo.Enabled = False
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), Colecciones.getError("00000"), ex)
      End Try
   End Sub
#End Region

#Region " Metodos "
   Private Sub AsignarBinding()
      Try
         m_listBindHelper = New List(Of ACBindHelper)()

         m_listBindHelper.Add(ACBindHelper.ACBind(actxaCliRuc, "Text", managerFletePorRuta.TRAN_FletePorRuta, "ENTID_Codigo"))
         m_listBindHelper.Add(ACBindHelper.ACBind(actxnIGV, "Checked", managerFletePorRuta.TRAN_FletePorRuta, "FLERT_ConIGV"))
         m_listBindHelper.Add(ACBindHelper.ACBind(actxnMontoXTm, "Text", managerFletePorRuta.TRAN_FletePorRuta, "FLERT_Importe"))
         m_listBindHelper.Add(ACBindHelper.ACBind(txtCarga, "Text", managerFletePorRuta.TRAN_FletePorRuta, "FLERT_Glosa"))
         m_listBindHelper.Add(ACBindHelper.ACBind(cmbMoneda, "SelectedValue", managerFletePorRuta.TRAN_FletePorRuta, "TIPOS_CodTipoMoneda"))

      Catch ex As Exception
         Throw ex
      End Try
   End Sub

   Private Sub setInstancia(ByVal _opcion As ACFramework.ACUtilitarios.ACSetInstancia)
      acTool.ACBtnGrabar.Enabled = True
      Select Case _opcion
         Case ACFramework.ACUtilitarios.ACSetInstancia.Nuevo
            ACFramework.ACUtilitarios.ACSetControl(pnlDatos, True)
            ACFramework.ACUtilitarios.ACSetControl(pnlDatos, False, ACFramework.ACUtilitarios.TipoPropiedad.ACReadOnly)
            ACFramework.ACUtilitarios.ACLimpiaVar(pnlDatos)

            actxaCliente.ACAyuda.Enabled = True
            actxaCliRuc.ACAyuda.Enabled = True
            actxaCodRuta.ACAyuda.Enabled = True
            actxaRuta.ACAyuda.Enabled = True

            btnRNuevo.Enabled = True
            btnREditar.Enabled = True
            btnRClean.Enabled = True
            chkIGV.Checked = False
         Case ACFramework.ACUtilitarios.ACSetInstancia.Modificado
            ACFramework.ACUtilitarios.ACSetControl(pnlDatos, True)
            ACFramework.ACUtilitarios.ACSetControl(pnlDatos, False, ACFramework.ACUtilitarios.TipoPropiedad.ACReadOnly)
            ACFramework.ACUtilitarios.ACLimpiaVar(pnlDatos)
            actxaCliRuc.ReadOnly = True
            actxaCliente.ReadOnly = True
            tabMantenimiento.SelectedTab = tabDatos
            acTool.ACBtnGrabar.Enabled = False
            actxaCliente.ACAyuda.Enabled = False
            actxaCliRuc.ACAyuda.Enabled = False
            actxaCodRuta.ACAyuda.Enabled = True
            actxaRuta.ACAyuda.Enabled = True

            btnRNuevo.Enabled = True
            btnREditar.Enabled = True
            btnRClean.Enabled = True
            'txtCodigo.Enabled = False
         Case ACFramework.ACUtilitarios.ACSetInstancia.Guardar, ACFramework.ACUtilitarios.ACSetInstancia.Deshacer
            tabMantenimiento.SelectedTab = tabBusqueda
         Case ACUtilitarios.ACSetInstancia.Deshacer
            tabMantenimiento.SelectedTab = tabBusqueda
      End Select
      acTool.ACBtnEliminar.Visible = False
   End Sub

   Private Function getCampo() As String
      Try
         If (rbtnCodigo.Checked) Then
            Return "ENTID_Codigo"
         ElseIf rbtnCliente.Checked Then
            Return "ENTID_RazonSocial"
         Else
            Return "ENTID_RazonSocial"
         End If
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   ''' <summary>
   ''' Ejecutar la busqueda de una cadena en la tabla Neumaticos
   ''' </summary>
   ''' <param name="x_cadena">Cadena objetivo</param>
   ''' <returns></returns>
   Private Function busqueda(ByVal x_cadena As String) As Boolean
      Try
         If txtBusqueda.ACEstadoAutoAyuda Then
            If managerEntidades.Busqueda(x_cadena, getCampo(), m_perfil) Then
               acTool.ACBtnEliminar.Enabled = True
               acTool.ACBtnModificar.Enabled = True
            Else
               acTool.ACBtnEliminar.Enabled = False
               acTool.ACBtnModificar.Enabled = False
            End If
            cargarDatos()
         End If
         Return acTool.ACBtnEliminar.Enabled
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Convert.ToString(Text)), "No se puede cargar la ayuda de los conductores", ex)
      End Try
      Return False
   End Function

   ''' <summary>
   ''' Cargar los datos en el control Visual C1FlexGrid
   ''' </summary>
   Private Sub cargarDatos()
      Try
         bs_bentidades = New BindingSource()
         bs_bentidades.DataSource = managerEntidades.getListEntidades
         c1grdBusqueda.DataSource = bs_bentidades
         bnavBusqueda.BindingSource = bs_bentidades
      Catch ex As Exception
         Throw ex
      End Try
   End Sub

   Private Sub formatearGrilla()
      Dim index As Integer = 1
      Try
         ACFrameworkC1.ACUtilitarios.ACFormatearGrilla(c1grdBusqueda, 1, 1, 8, 1, 0)
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Codigo", "ENTID_Codigo", "ENTID_Codigo", 150, True, False, "System.String", "########0") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Nombres/Razon Social", "ENTID_RazonSocial", "ENTID_RazonSocial", 150, True, False, "System.String", "") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Tipo Doc.", "TIPO_DOCUMENTO", "TIPO_DOCUMENTO", 150, True, False, "System.String", "") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Doc. Identidad", "ENTID_NroDocumento", "ENTID_NroDocumento", 150, True, False, "System.String", "") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Telefono", "ENTID_Telefono1", "ENTID_Telefono1", 150, True, False, "System.String", "") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "E-Mail", "ENTID_EMail", "ENTID_EMail", 150, True, False, "System.String", "") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Dirección", "ENTID_Direccion", "ENTID_Direccion", 150, True, False, "System.String", "") : index += 1

         c1grdBusqueda.AllowEditing = False
         c1grdBusqueda.AllowSorting = AllowSortingEnum.SingleColumn
         c1grdBusqueda.Styles.Alternate.BackColor = Color.WhiteSmoke
         c1grdBusqueda.Styles.Fixed.TextAlign = TextAlignEnum.CenterCenter
         c1grdBusqueda.Styles.Highlight.BackColor = Color.Gray
         c1grdBusqueda.SelectionMode = SelectionModeEnum.Row
         c1grdBusqueda.VisualStyle = VisualStyle.Office2007Blue


      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Text), "No se puede dar formato a la grilla", ex)
      End Try
   End Sub

   Private Sub AyudaRutas(ByVal x_cadenas As String, ByVal x_campo As String)
      Try
         Dim _where As New Hashtable()
         _where.Add(x_campo, New ACWhere(x_cadenas, ACWhere.TipoWhere._Like))
         If managerTRAN_Rutas.Ayuda(_where) Then
            Dim Ayuda As New ACControlesC1.ACAyudaFlex("Buscar Ruta", managerTRAN_Rutas.DTTRAN_Rutas, False)
            If Ayuda.ShowDialog() = Windows.Forms.DialogResult.OK Then
               actxaCodRuta.Text = Ayuda.Respuesta.Rows(0)("Codigo").ToString()
               actxaRuta.Text = Ayuda.Respuesta.Rows(0)("Nombre").ToString()
               Label1.Focus()
            End If
         Else
            ACControles.ACDialogos.ACMostrarMensajeInformacion(String.Format("Información: {0}", Me.Text), "No se puede cargar la ayuda, posiblemente no haya datos que mostrar")
         End If
      Catch ex As Exception
         Throw ex
      End Try
   End Sub

   Private Sub Calcular()
      Try
         Dim _monto As Decimal = actxnMontoXTm.Text
         actxnIGV = _monto * (100 + Parametros.GetParametro(ACEVentas.EParametros.TipoParametros.PIGV)) / 100
      Catch ex As Exception
         actxnIGV.Text = "0.00"
      End Try
   End Sub

   
#End Region

#Region " Metodos de Controles"
   Private Sub actxaCodRuta_KeyDown(sender As Object, e As KeyEventArgs) Handles actxaCodRuta.KeyDown
      Try
         If e.KeyData = Keys.Enter Then
            If actxaCodRuta.Text.Length > 0 Then
               If IsNumeric(actxaCodRuta.Text) Then
                  If managerTRAN_Rutas.Cargar(actxaCodRuta.Text) Then
                     actxaCodRuta.Text = managerTRAN_Rutas.TRAN_Rutas.RUTAS_Id
                     actxaRuta.Text = managerTRAN_Rutas.TRAN_Rutas.RUTAS_Nombre
                     Label1.Focus()
                  End If
               End If
            End If
         End If
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), String.Format(Colecciones.getError("00101"), "Cargar Codigo de Ruta"), ex)
      End Try
   End Sub

   Private Sub actxaCodRuta_ACAyudaClick(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles actxaCodRuta.ACAyudaClick
      Try
         If actxaCodRuta.ACAyuda.Enabled Then AyudaRutas(actxaCodRuta.Text, "RUTAS_Id")
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError("Error: " & Convert.ToString(Me.Text), "No se puede cargar la ayuda de las rutas", ex)
      End Try
   End Sub

   Private Sub chkIGV_CheckedChanged(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles chkIGV.CheckedChanged
      actxnIGV.Enabled = chkIGV.Checked
      Try
         If chkIGV.Checked Then
            Dim _igv As Decimal = Parametros.GetParametro(ACEVentas.EParametros.TipoParametros.PIGV)
            Dim _monto As Decimal = actxnMontoXTm.Text
            actxnIGV.Text = _monto * (_igv / 100)
            actxnIGV.Formatear()
         Else
            actxnIGV.Text = "0.00"
         End If
         Calcular()
      Catch ex As Exception

      End Try
   End Sub

   Private Sub btnRNuevo_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnRNuevo.Click
      Try
         Dim frmRuta As New MRutas(MRutas.TRuta.Nueva) With {.StartPosition = FormStartPosition.CenterScreen}
         If frmRuta.ShowDialog() = Windows.Forms.DialogResult.OK Then
            actxaCodRuta.Text = frmRuta.TRAN_Rutas.RUTAS_Id
            actxaRuta.Text = frmRuta.TRAN_Rutas.RUTAS_Nombre
         End If
      Catch ex As Exception
         Throw ex
      End Try
   End Sub

   Private Sub btnREditar_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles btnREditar.Click
      Try
         If actxaCodRuta.Text.Length > 0 Then
            Dim _id As Long = actxaCodRuta.Text
            Dim frmRuta As New MRutas(_id) With {.StartPosition = FormStartPosition.CenterScreen}
            If frmRuta.ShowDialog() = Windows.Forms.DialogResult.OK Then
               actxaCodRuta.Text = frmRuta.TRAN_Rutas.RUTAS_Id
               actxaRuta.Text = frmRuta.TRAN_Rutas.RUTAS_Nombre
            End If
         End If
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), "Ocurrio un error en el proceso Editar la Ruta", ex)
      End Try
   End Sub
#End Region

   Private Sub txtBusqueda_ACAyudaClick(sender As Object, e As EventArgs) Handles txtBusqueda.ACAyudaClick
      busqueda(txtBusqueda.Text)
   End Sub

   Private Sub btnConsultar_Click(sender As Object, e As EventArgs) Handles btnConsultar.Click
      busqueda(txtBusqueda.Text)
   End Sub

   Private Sub txtBusqueda_KeyDown(sender As Object, e As KeyEventArgs) Handles txtBusqueda.KeyDown
      If e.KeyData = Keys.Enter Then
         busqueda(txtBusqueda.Text)
      End If
   End Sub

   Private Sub acTool_ACBtnCancelar_Click(sender As Object, e As EventArgs) Handles acTool.ACBtnCancelar_Click
      setInstancia(ACUtilitarios.ACSetInstancia.Deshacer)
   End Sub

   Private Sub acTool_ACBtnGrabar_Click(sender As Object, e As EventArgs) Handles acTool.ACBtnGrabar_Click

   End Sub

   Private Sub acTool_ACBtnModificar_Click(sender As Object, e As EventArgs) Handles acTool.ACBtnModificar_Click
      Try
         If Not IsNothing(bs_bentidades) Then
            If Not IsNothing(bs_bentidades.Current) Then
               '' Codigo
               setInstancia(ACUtilitarios.ACSetInstancia.Modificado)
               actxaCliRuc.Text = CType(bs_bentidades.Current, ACEVentas.EEntidades).ENTID_Codigo
               actxaCliente.Text = CType(bs_bentidades.Current, ACEVentas.EEntidades).ENTID_RazonSocial

            Else
               Throw New Exception("No se puede cargar el documento")
            End If
         Else
            Throw New Exception("No se puede cargar el documento")
         End If
      Catch ex As Exception
         setInstancia(ACUtilitarios.ACSetInstancia.Deshacer)
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), String.Format(Colecciones.getError("00101"), "Modificar Fletes Por Ruta"), ex)
      End Try
   End Sub

   Private Sub acTool_ACBtnSalir_Click(sender As Object, e As EventArgs) Handles acTool.ACBtnSalir_Click
      Me.Close()
   End Sub

   Private Sub tsbtnNueDireccion_Click(sender As Object, e As EventArgs) Handles tsbtnAgregar.Click

   End Sub
End Class