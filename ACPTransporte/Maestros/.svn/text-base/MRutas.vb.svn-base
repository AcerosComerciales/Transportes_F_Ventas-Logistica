Imports ACBTransporte
Imports ACETransporte
Imports ACFramework

Imports C1.Win.C1FlexGrid
Imports ACEVentas

Public Class MRutas
#Region " Variables "
   Private managerTRAN_Rutas As BTRAN_Rutas
   Private bs_btran_rutas As BindingSource
   Private m_etran_rutas As ETRAN_Rutas
   Private m_listBindHelper As List(Of ACBindHelper)
   Private frmUbigeos As ACControles.ACAyudaTreeView
   Private m_inicio As TRuta

   Enum TRuta
      Nueva
      Modificar
      Normal
   End Enum

#End Region

#Region " Propiedades "

   Public Property TRAN_Rutas() As ETRAN_Rutas
      Get
         Return m_etran_rutas
      End Get
      Set(ByVal value As ETRAN_Rutas)
         m_etran_rutas = value
      End Set
   End Property

#End Region

#Region " Constructores "
   Public Sub New()

      ' This call is required by the Windows Form Designer.
      InitializeComponent()

      Try
         Inicio()
         m_inicio = TRuta.Normal
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Convert.ToString(Text)), "No se puede cargar los controles iniciales", ex)
      End Try
   End Sub

   Public Sub New(ByVal x_inicio As TRuta)

      ' This call is required by the Windows Form Designer.
      InitializeComponent()

      Try
         Inicio()
         m_inicio = x_inicio
         acTool_ACBtnNuevo_Click(Nothing, Nothing)
         acTool.setInstancia(ACControles.ACToolBarMantVertical.TipoInstancia.Nuevo)
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Convert.ToString(Text)), "No se puede cargar los controles iniciales", ex)
      End Try
   End Sub

   Public Sub New(ByVal x_rutas_id As Long)

      ' This call is required by the Windows Form Designer.
      InitializeComponent()

      Try
         Inicio()
         m_inicio = TRuta.Modificar
         setInstancia(ACFramework.ACUtilitarios.ACSetInstancia.Modificado)
         cargar(x_rutas_id)
         tabMantenimiento.SelectedTab = tabDatos
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Convert.ToString(Text)), "No se puede cargar los controles iniciales", ex)
      End Try
   End Sub

   Private Sub Inicio()
      tabMantenimiento.HideTabsMode = Crownwood.DotNetMagic.Controls.HideTabsModes.HideAlways
      tabMantenimiento.SelectedTab = tabBusqueda
      formatearGrilla()
      cargarCombos()
      managerTRAN_Rutas = New BTRAN_Rutas

      acTool.ACBtnEliminar.Enabled = False
      acTool.ACBtnModificar.Enabled = False

      txtBusqueda.ACActivarAyudaAuto = True
      txtBusqueda.ACLongitudAceptada = Parametros.GetParametro(EParametros.TipoParametros.pg_LongTexAyuda)
   End Sub
#End Region

#Region " Metodos "
#Region " Utilitarios "
   ''' <summary>
   ''' Dar Formato a la grilla de busqueda
   ''' </summary>
   ''' <remarks></remarks>
   Private Sub formatearGrilla()
      Dim index As Integer = 1
      Try
         ACFrameworkC1.ACUtilitarios.ACFormatearGrilla(c1grdBusqueda, 1, 1, 7, 1, 0)
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Codigo", "RUTAS_Codigo", "RUTAS_Codigo", 150, True, False, "System.Integer", "") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Sucursal", "SUCUR_Nombre", "SUCUR_Nombre", 150, False, False, "System.String", "") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Nombre", "RUTAS_Nombre", "RUTAS_Nombre", 150, True, False, "System.String", "") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Origen", "UBIGO_ORIGEN", "UBIGO_ORIGEN", 150, True, False, "System.String", "") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Destino", "UBIGO_DESTINO", "UBIGO_DESTINO", 150, True, False, "System.String", "") : index += 1
         ACFrameworkC1.ACUtilitarios.ACAgregarColumna(c1grdBusqueda, index, "Distancia (Km)", "RUTAS_Km", "RUTAS_Km", 150, True, False, "System.String", "") : index += 1

         c1grdBusqueda.AllowEditing = False
         c1grdBusqueda.Styles.Alternate.BackColor = Color.WhiteSmoke
         c1grdBusqueda.Styles.Fixed.TextAlign = TextAlignEnum.CenterCenter
         c1grdBusqueda.Styles.Highlight.BackColor = Color.Gray
         c1grdBusqueda.SelectionMode = SelectionModeEnum.Row


      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), "No se puede dar formato a la grilla", ex)
      End Try
   End Sub

   Private Sub cargarCombos()
      Try
      Catch ex As Exception
         Throw ex
      End Try
   End Sub

   Private Sub setInstancia(ByVal _opcion As ACFramework.ACUtilitarios.ACSetInstancia)

      Select Case _opcion
         Case ACFramework.ACUtilitarios.ACSetInstancia.Nuevo
            ACFramework.ACUtilitarios.ACSetControl(pnlDatos, True)
            ACFramework.ACUtilitarios.ACLimpiaVar(pnlDatos)
            'txtCodigo.Enabled = False
         Case ACFramework.ACUtilitarios.ACSetInstancia.Modificado
            ACFramework.ACUtilitarios.ACSetControl(pnlDatos, True)
            'txtCodigo.Enabled = False
         Case ACFramework.ACUtilitarios.ACSetInstancia.Guardar

         Case ACFramework.ACUtilitarios.ACSetInstancia.Deshacer

      End Select

   End Sub
#End Region

#Region " Cargar Datos "
   ''' <summary>
   ''' Cargar los datos en el control Visual C1FlexGrid
   ''' </summary>
   Private Sub cargarDatos()
      Try
         bs_btran_rutas = New BindingSource()
         bs_btran_rutas.DataSource = managerTRAN_Rutas.getListTRAN_Rutas()
         c1grdBusqueda.DataSource = bs_btran_rutas
         bnavBusqueda.BindingSource = bs_btran_rutas
      Catch ex As Exception
         Throw ex
      End Try
   End Sub

   ''' <summary>
   ''' Realiza el enlace de los controles visuales con la clase esquema
   ''' </summary>
   Private Sub AsignarBinding()
      Try
         m_listBindHelper = New List(Of ACBindHelper)()
         m_listBindHelper.Add(ACBindHelper.ACBind(txtCodigo, "Text", m_etran_rutas, "RUTAS_Codigo"))
         m_listBindHelper.Add(ACBindHelper.ACBind(txtNombre, "Text", m_etran_rutas, "RUTAS_Nombre"))
         If (m_etran_rutas.RUTAS_Fecha.Year < 1700) Then m_etran_rutas.RUTAS_Fecha = DateTime.Now
         m_listBindHelper.Add(ACBindHelper.ACBind(dtpFecIngreso, "Value", m_etran_rutas, "RUTAS_Fecha"))

         m_listBindHelper.Add(ACBindHelper.ACBind(actxaOrigen, "Text", m_etran_rutas, "UBIGO_CodOrigen"))
         m_listBindHelper.Add(ACBindHelper.ACBind(actxaDestino, "Text", m_etran_rutas, "UBIGO_CodDestino"))
         m_listBindHelper.Add(ACBindHelper.ACBind(actxnDistancia, "Text", m_etran_rutas, "RUTAS_Km"))
         m_listBindHelper.Add(ACBindHelper.ACBind(actxaTiempo, "Text", m_etran_rutas, "RUTAS_Tiempo"))

      Catch ex As Exception
         Throw ex
      End Try
   End Sub

   Private Sub cargar(ByVal x_codigo As Long)
      Try
         If managerTRAN_Rutas.Cargar(x_codigo, True) Then
            m_etran_rutas = managerTRAN_Rutas.getTRAN_Rutas()
            txtOrigen.Text = managerTRAN_Rutas.TRAN_Rutas.UBIGO_Origen
            txtDestino.Text = managerTRAN_Rutas.TRAN_Rutas.UBIGO_Destino
            AsignarBinding()
            tabMantenimiento.SelectedTab = tabDatos
            acTool.setInstancia(ACControles.ACToolBarMantVertical.TipoInstancia.Modificar)
         End If
      Catch ex As Exception
         acTool.setInstancia(ACControles.ACToolBarMantVertical.TipoInstancia.Cancelar)
         Throw ex
      End Try
   End Sub
#End Region

   ''' <summary>
   ''' Ejecutar la busqueda de una cadena en la tabla conductores
   ''' </summary>
   ''' <param name="x_cadena">Cadena objetivo</param>
   ''' <returns></returns>
   Private Function busqueda(ByVal x_cadena As String) As Boolean
      Try
         If txtBusqueda.ACEstadoAutoAyuda Then
            If managerTRAN_Rutas.Busqueda(x_cadena) Then
               acTool.ACBtnEliminar.Enabled = True
               acTool.ACBtnModificar.Enabled = True
            Else
               acTool.ACBtnEliminar.Enabled = False
               acTool.ACBtnModificar.Enabled = False
            End If
            cargarDatos()
         End If
         Return acTool.ACBtnModificar.Enabled
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Text), "No se puede cargar la ayuda de los conductores", ex)
      End Try
      Return False
   End Function
#End Region

#Region " Metodos de Controles"
#Region " Tool Bar "
   Private Sub acTool_ACBtnNuevo_Click(ByVal sender As Object, ByVal e As EventArgs) Handles acTool.ACBtnNuevo_Click
      Try
         tabMantenimiento.SelectedTab = tabDatos

         m_etran_rutas = New ETRAN_Rutas()
         m_etran_rutas.Instanciar(ACEInstancia.Nuevo)
         setInstancia(ACFramework.ACUtilitarios.ACSetInstancia.Nuevo)
         AsignarBinding()
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), "Ocurrio un error en el proceso Nueva Ruta", ex)
      End Try
   End Sub

   Private Sub acTool_ACBtnCancelar_Click(ByVal sender As Object, ByVal e As EventArgs) Handles acTool.ACBtnCancelar_Click
      Try
         tabMantenimiento.SelectedTab = tabBusqueda
         For Each Item As ACBindHelper In m_listBindHelper
            Item.ACUnBind()
         Next
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), "Ocurrio un error en el proceso Cancelar Ruta", ex)
      End Try
   End Sub

   Private Sub acTool_ACBtnModificar_Click(ByVal sender As Object, ByVal e As EventArgs) Handles acTool.ACBtnModificar_Click
      Try
         If bs_btran_rutas.Current IsNot Nothing Then
            setInstancia(ACFramework.ACUtilitarios.ACSetInstancia.Modificado)
            Dim x_codigo As Integer = CType(bs_btran_rutas.Current, ETRAN_Rutas).RUTAS_Id
            cargar(x_codigo)
            tabMantenimiento.SelectedTab = tabDatos
         End If
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), "Ocurrio un error en el proceso Modificar Ruta", ex)
      End Try
   End Sub

   Private Sub acTool_ACBtnGrabar_Click(ByVal sender As Object, ByVal e As EventArgs) Handles acTool.ACBtnGrabar_Click
      Dim msg As String = ""
      Try
         If ACFramework.ACUtilitarios.ACDatosOk(pnlDatos, msg) Then
            If m_etran_rutas.Nuevo = True Then
               ''Correlativo
               m_etran_rutas.RUTAS_Id = managerTRAN_Rutas.getCorrelativo()
            End If
            managerTRAN_Rutas.setTRAN_Rutas(m_etran_rutas)

            If managerTRAN_Rutas.Guardar(GApp.Usuario, True) Then
               ACControles.ACDialogos.ACMostrarMensajeSatisfactorio(String.Format("Información: {0}", Me.Text), "Grabado satisfactoriamente")
               tabMantenimiento.SelectedTab = tabBusqueda
               acTool.ACSelectTabInicio = ACControles.ACToolBarMantVertical.Tabs.TabIni
               busqueda(txtBusqueda.Text)

               Select Case m_inicio
                  Case TRuta.Nueva
                     Me.DialogResult = Windows.Forms.DialogResult.OK
                     Me.Close()
                  Case TRuta.Modificar
                     Me.DialogResult = Windows.Forms.DialogResult.OK
                     Me.Close()
               End Select
            End If
         Else
            ACControles.ACDialogos.ACMostrarMensajeInformacion(String.Format("Información: {0}", Me.Text), String.Format("No se puede grabar, faltan datos obligatorios: {0}", msg))
         End If
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), "No se puede grabar", ex)
      End Try
   End Sub

   Private Sub acTool_ACBtnSalir_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles acTool.ACBtnSalir_Click
      Me.Close()
   End Sub

   Private Sub acTool_ACBtnEliminar_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles acTool.ACBtnEliminar_Click
      Try
         If ACControles.ACDialogos.ACMostrarMensajePregunta(String.Format("Eliminar Registro: {0}", Text), String.Format("Desea eliminar el registro: {0}?", CType(bs_btran_rutas.Current, ETRAN_Rutas).RUTAS_Nombre), ACControles.ACDialogos.LabelBotom.Si_No) = DialogResult.Yes Then
            m_etran_rutas = CType(bs_btran_rutas.Current, ETRAN_Rutas)
            m_etran_rutas.Instanciar(ACEInstancia.Eliminado)
            managerTRAN_Rutas.setTRAN_Rutas(m_etran_rutas)
            managerTRAN_Rutas.Guardar(GApp.Usuario)
            ACControles.ACDialogos.ACMostrarMensajeSatisfactorio(String.Format("Información: {0}", Text), "Eliminado satisfactoriamente")
            busqueda(txtBusqueda.Text)
         End If
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), "No se puede Eliminar", ex)
      End Try
   End Sub
#End Region

   Private Sub _KeyUp(ByVal sender As System.Object, ByVal e As System.Windows.Forms.KeyEventArgs) Handles MyBase.KeyUp
      If e.KeyCode = Keys.Enter Then
         If sender.Name = "txtBusqueda" Then
            Exit Sub
         End If
         If sender.Name = "acTool" Then
            Exit Sub
         End If
         SendKeys.Send("{TAB}")
      End If
   End Sub

   Private Sub txtBusqueda_ACAyudaClick(ByVal sender As Object, ByVal e As EventArgs) Handles txtBusqueda.ACAyudaClick
      Try
         busqueda(txtBusqueda.Text)
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Convert.ToString(Me.Text)), "No se puede cargar la ayuda de los conductores", ex)
      End Try
   End Sub

   Private Sub txtBusqueda_KeyUp(ByVal sender As Object, ByVal e As KeyEventArgs) Handles txtBusqueda.KeyUp
      Try
         If e.KeyCode = Keys.Enter Then
            busqueda(txtBusqueda.Text)
         End If
      Catch ex As Exception
         Throw ex
      End Try
   End Sub

   Private Sub c1grdDetalle_MouseClick(ByVal sender As Object, ByVal e As MouseEventArgs) Handles c1grdBusqueda.MouseDoubleClick
      Try
         If e.X > c1grdBusqueda.Rows.Fixed Then
            acTool_ACBtnModificar_Click(Nothing, Nothing)
         End If
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Convert.ToString(Me.Text)), "No se puede cargar el registro seleccionado", ex)
      End Try
   End Sub

   Private Sub actxaOrigen_ACAyudaClick(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles actxaOrigen.ACAyudaClick
      Try
         If IsNothing(frmUbigeos) Then
            frmUbigeos = New ACControles.ACAyudaTreeView(Colecciones.UbigeosDT, "Ubigeos", True, "Ubigeos", True)
         End If
         If frmUbigeos.ShowDialog() = Windows.Forms.DialogResult.OK Then
            If frmUbigeos.Codigo = "" Then
               txtOrigen.Text = ""
               actxaOrigen.Text = ""
            Else
               txtOrigen.Text = frmUbigeos.Desc
               actxaOrigen.Text = frmUbigeos.Codigo
            End If
         End If
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), "Ocurrio un error en el proceso Cargar Ubigeos Origen", ex)
      End Try
   End Sub

   Private Sub actxaDestino_ACAyudaClick(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles actxaDestino.ACAyudaClick
      Try
         If IsNothing(frmUbigeos) Then
            frmUbigeos = New ACControles.ACAyudaTreeView(Colecciones.UbigeosDT, "Ubigeos", True, "Ubigeos", True)
         End If
         If frmUbigeos.ShowDialog() = Windows.Forms.DialogResult.OK Then
            If frmUbigeos.Codigo = "" Then
               txtDestino.Text = ""
               actxaDestino.Text = ""
            Else
               txtDestino.Text = frmUbigeos.Desc
               actxaDestino.Text = frmUbigeos.Codigo
            End If
         End If
      Catch ex As Exception
         ACControles.ACDialogos.ACMostrarMensajeError(String.Format("Error: {0}", Me.Text), "Ocurrio un error en el proceso Cargar Ubigeos Destino", ex)
      End Try
   End Sub
#End Region

End Class