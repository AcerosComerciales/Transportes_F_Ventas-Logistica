Imports System
Imports System.Data
Imports System.Data.Common
Imports System.Collections.Generic

Imports ACFramework
Imports DAConexion
Imports ACETransporte
Imports ACELogistica

Public Class DGenerarGuias

#Region " Variables "
   Private m_formatofecha As String
#End Region

#Region " Constructores "
   Public Sub New()
      m_formatofecha = "yyyy-MM-dd HH:mm:ss.fff"
   End Sub
#End Region

#Region " Procedimientos Almacenados "
   Public Function getNumero(ByVal x_serie As String, ByVal x_tipos_tipodocumento As String) As Integer
      Try
         DAEnterprise.AsignarProcedure(getSelectAll(x_serie, x_tipos_tipodocumento), CommandType.Text)
         Dim m_datos As DataTable = DAEnterprise.ExecuteDataSet().Tables(0)
         If m_datos.Rows.Count > 0 Then
            Return CType(m_datos.Rows(0)("Numero"), Integer)
         Else
            Return 0
         End If
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function getGuiaTransportista(ByRef x_tran_guiastransportista As ETRAN_GuiasTransportista, ByVal x_gtran_codigo As String, ByVal x_gtran_estado As String) As Boolean
      Try
         DAEnterprise.AsignarProcedure(getSelectBy(x_gtran_codigo, x_gtran_estado), CommandType.Text)
         Using reader As DbDataReader = DAEnterprise.ExecuteDataReader()
            If reader.HasRows Then
               reader.Read()
               ACEsquemas.ACCargarEsquema(reader, x_tran_guiastransportista)
               x_tran_guiastransportista.Instanciar(ACEInstancia.Consulta)
               Return True
            Else
               Return False
            End If
         End Using
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   ''' <summary> 
   ''' Capa de Datos: TRAN_GUIASS_ObtenerGuias
   ''' </summary>
   ''' <param name="x_gtran_codigo">Parametro 1: </param> 
   ''' <returns></returns> 
   ''' <remarks></remarks> 
   Public Function TRAN_GUIASS_ObtenerGuias(ByRef x_tran_guiastransportista As ETRAN_GuiasTransportista, ByVal x_gtran_codigo As String) As Boolean
      Try
         DAEnterprise.AsignarProcedure("TRAN_GUIASS_ObtenerGuias")
         DAEnterprise.AgregarParametro("@GTRAN_Codigo", x_gtran_codigo, DbType.String, 15)
         Using reader As DbDataReader = DAEnterprise.ExecuteDataReader()
            If reader.HasRows Then
               reader.Read()
               ACEsquemas.ACCargarEsquema(reader, x_tran_guiastransportista)
               x_tran_guiastransportista.Instanciar(ACEInstancia.Consulta)
               Return True
            Else
               Return False
            End If
         End Using
         Return True
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function CargarGuia(ByRef m_listEABAS_DocsCompraDetalle As List(Of EABAS_DocsCompraDetalle), ByVal x_docco_codigo As String, ByVal x_entid_codigoproveedor As String) As Boolean
      Try
         DAEnterprise.AsignarProcedure(getSelectGuia(x_docco_codigo, x_entid_codigoproveedor), CommandType.Text)
         Using reader As DbDataReader = DAEnterprise.ExecuteDataReader()
            If reader.HasRows Then
               Dim _utilitarios As New ACEsquemas(New EABAS_DocsCompraDetalle())
               While reader.Read()
                  Dim e_eabas_docscompradetalle As New EABAS_DocsCompraDetalle()
                  _utilitarios.ACCargarEsquemas(reader, e_eabas_docscompradetalle)
                  e_eabas_docscompradetalle.Instanciar(ACEInstancia.Consulta)
                  m_listEABAS_DocsCompraDetalle.Add(e_eabas_docscompradetalle)
               End While
               Return True
            Else
               Return False
            End If
         End Using
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function getProveedor(ByRef listEABAS_DocsCompra As List(Of EABAS_DocsCompra), ByVal x_where As Hashtable) As Boolean
      Try
         DAEnterprise.AsignarProcedure(getSelectProveedor(x_where), CommandType.Text)
         Using reader As DbDataReader = DAEnterprise.ExecuteDataReader()
            If reader.HasRows Then
               Dim _utilitarios As New ACEsquemas(New EABAS_DocsCompra())
               While reader.Read()
                  Dim e_event_docsventa As New EABAS_DocsCompra()
                  _utilitarios.ACCargarEsquemas(reader, e_event_docsventa)

                  e_event_docsventa.Instanciar(ACEInstancia.Consulta)
                  listEABAS_DocsCompra.Add(e_event_docsventa)
               End While
               Return True
            Else
               Return False
            End If
         End Using
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   ''' <summary> 
   ''' Capa de Datos: LOGI_DOCSS_FacturasCemento
   ''' </summary>
   ''' <param name="x_fecini">Parametro 1: </param> 
   ''' <param name="x_fecfin">Parametro 2: </param> 
   ''' <param name="x_cadena">Parametro 3: </param> 
   ''' <param name="x_campo">Parametro 4: </param> 
   ''' <returns></returns> 
   ''' <remarks></remarks> 
   Public Function LOGI_DOCSS_FacturasCemento(ByVal m_listabas_docscompra As List(Of EABAS_DocsCompra), ByVal x_fecini As Date, ByVal x_fecfin As Date, ByVal x_cadena As String, ByVal x_campo As Short) As Boolean
      Try
         DAEnterprise.AsignarProcedure("LOGI_DOCSS_FacturasCemento")
         DAEnterprise.AgregarParametro("@FecIni", x_fecini, DbType.DateTime, 8)
         DAEnterprise.AgregarParametro("@FecFin", x_fecfin, DbType.DateTime, 8)
         DAEnterprise.AgregarParametro("@Cadena", x_cadena, DbType.String, 100)
         DAEnterprise.AgregarParametro("@Campo", x_campo, DbType.Int16, 2)
         Using reader As DbDataReader = DAEnterprise.ExecuteDataReader()
            If reader.HasRows Then
               While reader.Read()
                  Dim _abas_docscompra As New EABAS_DocsCompra()
                  ACEsquemas.ACCargarEsquema(reader, _abas_docscompra)
                  _abas_docscompra.Instanciar(ACEInstancia.Consulta)
                  m_listabas_docscompra.Add(_abas_docscompra)
               End While
               Return True
            Else
               Return False
            End If
         End Using
         Return True
      Catch ex As Exception
         Throw ex
      End Try
   End Function

#Region "Procedimientos Adicionales "

   Private Function getSelectAll(ByVal x_serie As String, ByVal x_tipos_tipodocumento As String) As String
      Dim sql As String = ""
      Try
         sql &= String.Format(" Select IsNull(Max(GTRAN_Numero), 0) As Numero from  [Transportes].[TRAN_GuiasTransportista] ", vbNewLine)
         sql &= String.Format(" Where GTRAN_Serie = '{0}' And TIPOS_CodTipoDocumento = '{1}'{2}", x_serie, x_tipos_tipodocumento, vbNewLine)

         Return sql
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Private Function getSelectBy(ByVal x_gtran_codigo As String, ByVal x_gtran_estado As String) As String
      Dim sql As String = ""
      Try
         App.Inicializar()
         sql &= String.Format(App.Hash("DGenerarGuias.getGuiaTransportista").ToString(), x_gtran_codigo, x_gtran_estado)
         Return sql
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Private Function getSelectGuia(ByVal x_docco_codigo As String, ByVal x_entid_codigoproveedor As String) As String
      Dim sql As String = ""
      Try
         App.Inicializar()
         sql = String.Format(App.Hash("DGenerarGuias.CargarGuia").ToString(), x_docco_codigo, x_entid_codigoproveedor)
         Return sql
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Private Function getSelectProveedor(ByVal x_where As Hashtable) As String
      Dim sql As String = ""
      Try
         App.Inicializar()
         sql = String.Format("{0} Where ", App.Hash("DGenerarGuias.getProveedor"))
         Dim _where As New ACGenerador(Of EABAS_DocsCompra)(m_formatofecha)
         sql &= _where.getWhere(x_where, True)
         sql &= String.Format(App.Hash("DGenerarGuias.getProveedor.where").ToString())
         Return sql
      Catch ex As Exception
         Throw ex
      End Try
   End Function
#End Region

#End Region

#Region " Metodos "

#End Region


End Class

