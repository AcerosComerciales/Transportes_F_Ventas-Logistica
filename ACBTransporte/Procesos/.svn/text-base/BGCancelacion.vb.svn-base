Imports System
Imports System.Data
Imports System.Collections.Generic

Imports ACETransporte
Imports ACDTransporte

Imports ACBVentas
Imports ACEVentas

Imports ACFramework
Imports DAConexion

Public Class BGCancelacion

#Region " Variables "
   Private m_dtGCancelacion As DataTable

	Private m_dsGCancelacion As DataSet
   Private d_gcancelacion As DGCancelacion

   Private m_eteso_caja As ETESO_Caja
   Private m_etran_recibos As ETRAN_Recibos

   Private m_tipocambiosunat As ETipoCambio
   Private m_tipocambiooficina As ETipoCambio

   Private m_listVENT_PagosFacturas As List(Of EVENT_DocsVenta)
   Private m_listEntidades As List(Of EEntidades)

   Private m_listteso_docspagos As List(Of ETESO_DocsPagos)

   Private m_pvent_id As Integer
   Private m_periodo As String
   Private m_zonas_codigo As String
   Private m_sucur_id As Short

   Private m_listvent_docsventa As List(Of EVENT_DocsVenta)
#End Region

#Region " Constructores "

   Public Sub New(ByVal x_pvent_id As Integer, ByVal x_periodo As String, ByVal x_zonas_codigo As String, ByVal x_sucur_id As Short)
      d_gcancelacion = New DGCancelacion
      m_pvent_id = x_pvent_id
      m_periodo = x_periodo
      m_zonas_codigo = x_zonas_codigo
      m_sucur_id = x_sucur_id
   End Sub

#End Region

#Region " Propiedades "

   Public Property TipoCambioSunat() As ETipoCambio
      Get
         Return m_tipocambiosunat
      End Get
      Set(ByVal value As ETipoCambio)
         m_tipocambiosunat = value
      End Set
   End Property

   Public Property TipoCambioOficina() As ETipoCambio
      Get
         Return m_tipocambiooficina
      End Get
      Set(ByVal value As ETipoCambio)
         m_tipocambiooficina = value
      End Set
   End Property


   Public Property TESO_Caja() As ETESO_Caja
      Get
         Return m_eteso_caja
      End Get
      Set(ByVal value As ETESO_Caja)
         m_eteso_caja = value
      End Set
   End Property

   Public Property DTGCancelacion() As DataTable
      Get
         Return m_dtGCancelacion
      End Get
      Set(ByVal value As DataTable)
         m_dtGCancelacion = value
      End Set
   End Property

   Public Property DSGCancelacion() As DataSet
      Get
         Return m_dsGCancelacion
      End Get
      Set(ByVal value As DataSet)
         m_dsGCancelacion = value
      End Set
   End Property

   Public Property ListVENT_PagosFacturas() As List(Of EVENT_DocsVenta)
      Get
         Return m_listVENT_PagosFacturas
      End Get
      Set(ByVal value As List(Of EVENT_DocsVenta))
         m_listVENT_PagosFacturas = value
      End Set
   End Property


   Public Property ListEntidades() As List(Of EEntidades)
      Get
         Return m_listEntidades
      End Get
      Set(ByVal value As List(Of EEntidades))
         m_listEntidades = value
      End Set
   End Property

   Public Property ListTESO_DocsPagos() As List(Of ETESO_DocsPagos)
      Get
         Return m_listteso_docspagos
      End Get
      Set(ByVal value As List(Of ETESO_DocsPagos))
         m_listteso_docspagos = value
      End Set
   End Property

   Public Property TRAN_Recibos() As ETRAN_Recibos
      Get
         Return m_etran_recibos
      End Get
      Set(ByVal value As ETRAN_Recibos)
         m_etran_recibos = value
      End Set
   End Property

   Public Property ListVENT_DocsVenta() As List(Of EVENT_DocsVenta)
      Get
         Return m_listvent_docsventa
      End Get
      Set(ByVal value As List(Of EVENT_DocsVenta))
         m_listvent_docsventa = value
      End Set
   End Property

#End Region

#Region " Funciones para obtencion de datos "

#End Region

#Region " Metodos "

   ''' <summary> 
   ''' Capa de Negocio: TRAN_CAJASS_FacturasXCancelar
   ''' </summary>
   ''' <param name="x_entid_codigo">Parametro 1: </param> 
   ''' <returns></returns> 
   ''' <remarks></remarks> 
   Public Function CargarFacturasXCancelar(ByVal x_entid_codigo As String, ByVal x_pvent_id As Long) As Boolean
      m_listvent_docsventa = New List(Of EVENT_DocsVenta)
      Try
         Return d_gcancelacion.TRAN_CAJASS_FacturasXCancelar(m_listvent_docsventa, x_entid_codigo, x_pvent_id)
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function CargarCaja(ByVal x_pvent_id As Long, ByVal x_caja_id As Long) As Boolean
      Try
         Dim _bteso_caja As New BTESO_Caja
         If _bteso_caja.Cargar(x_pvent_id, x_caja_id) Then
            m_eteso_caja = _bteso_caja.TESO_Caja
            Dim _btran_recibos = New BTRAN_Recibos
            If _btran_recibos.Cargar(_bteso_caja.TESO_Caja.CAJA_NroDocumento) Then
               m_etran_recibos = _btran_recibos.TRAN_Recibos
            End If
         End If
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function ModificarFecha(ByVal x_fecha As DateTime, ByVal x_importe As Decimal, ByVal x_usuario As String) As Boolean
      Try
         DAEnterprise.BeginTransaction()
         Dim _bteso_caja As New BTESO_Caja
         _bteso_caja.TESO_Caja = New ETESO_Caja
         _bteso_caja.TESO_Caja.CAJA_Id = m_eteso_caja.CAJA_Id
         _bteso_caja.TESO_Caja.PVENT_Id = m_pvent_id
         _bteso_caja.TESO_Caja.CAJA_Fecha = x_fecha
         _bteso_caja.TESO_Caja.CAJA_Importe = x_importe
         _bteso_caja.TESO_Caja.TIPOS_CodTransaccion = m_eteso_caja.TIPOS_CodTransaccion
         _bteso_caja.TESO_Caja.TIPOS_CodTipoOrigen = m_eteso_caja.TIPOS_CodTipoOrigen
         _bteso_caja.TESO_Caja.TIPOS_CodTipoDocumento = m_eteso_caja.TIPOS_CodTipoDocumento

         If _bteso_caja.Guardar(x_usuario) Then
            'If _bteso_caja.ModificarImpFec(x_fecha, x_importe, x_usuario) Then
            Dim _btran_recibos = New BTRAN_Recibos
            _btran_recibos.TRAN_Recibos = m_etran_recibos
            _btran_recibos.ModificarImpFec(x_fecha, x_importe, x_usuario)
            DAEnterprise.CommitTransaction()
            Return True
         End If
         DAEnterprise.RollBackTransaction()
         Return False
      Catch ex As Exception
         DAEnterprise.RollBackTransaction()
         Throw
      End Try
   End Function

   Public Function getUltimoTipoCambio() As Decimal
      Try
         Dim b_tipocambio As New BTipoCambio()
         If b_tipocambio.getUltTipoCambio() Then
            m_tipocambiosunat = b_tipocambio.TipoCambio
            Return m_tipocambiosunat.TIPOC_VentaSunat
         Else
            m_tipocambiosunat = New ETipoCambio
            Return 0
         End If
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function getUltimoTipoCambioOficina() As Decimal
      Try
         Dim b_tipocambio As New BTipoCambio()
         If b_tipocambio.getUltTipoCambioOficina() Then
            m_tipocambiooficina = b_tipocambio.TipoCambio
            Return m_tipocambiooficina.TIPOC_VentaOficina
         Else
            m_tipocambiooficina = New ETipoCambio
            Return 0
         End If
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function getTipoCambioSunat(ByVal x_fecha As Date) As Decimal
      Try
         Dim b_tipocambio As New BTipoCambio()
         If b_tipocambio.getTipoCambioSunat(x_fecha) Then
            m_tipocambiosunat = b_tipocambio.TipoCambio
            Return m_tipocambiosunat.TIPOC_VentaSunat
         Else
            m_tipocambiosunat = New ETipoCambio
            Return 0
         End If
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function getNroTransaccion(ByVal x_pvent_id As Long, ByVal x_serie As String) As Integer
      Dim x_where As New Hashtable
      Try
         x_where.Add("PVENT_Id", New ACWhere(x_pvent_id))
         x_where.Add("CAJA_Serie", New ACWhere(x_serie))
         Dim _caja As New BTESO_Caja
         Return _caja.getCorrelativo("CAJA_Numero", x_where)
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function Ayuda(ByVal x_fecini As Date, ByVal x_fecfin As Date, ByVal x_entid_codigo As String) As Boolean
      Try
         Dim _docspago As New BTESO_DocsPagos(m_pvent_id, m_periodo, m_zonas_codigo, m_sucur_id)
         If _docspago.Ayuda(x_fecini, x_fecfin, x_entid_codigo) Then
            m_dtGCancelacion = New DataTable() : m_dtGCancelacion = _docspago.DTTESO_DocsPagos
            Return True
         End If
         Return False
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function getPendiente(ByVal x_cadena As String, ByVal x_campo As String, ByVal x_todos As Boolean) As Boolean
      Try
         Dim _join As New List(Of ACJoin)
         Dim _where As New Hashtable()
         setJoinWhereEntidad(_join, _where, x_todos)
         _where.Add(x_campo, New ACWhere(x_cadena, ACWhere.TipoWhere._Like))
         Dim m_bentidades As New BEntidades
         If m_bentidades.CargarTodos(_join, _where, True) Then
            m_listEntidades = New List(Of EEntidades)(m_bentidades.ListEntidades)
         End If
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Private Sub setJoinWhereEntidad(ByRef _join As List(Of ACJoin), ByRef _where As Hashtable, ByVal x_todos As Boolean)
      Try
         _join.Add(New ACJoin(EVENT_DocsVenta.Esquema, EVENT_DocsVenta.Tabla, "Vent", ACJoin.TipoJoin.Left _
                            , New ACCampos() {New ACCampos("ENTID_CodigoCliente", "ENTID_Codigo")} _
                            , New ACCampos() {}))
         _join.Add(New ACJoin(ETipos.Esquema, ETipos.Tabla, "TDoc", ACJoin.TipoJoin.Inner _
                            , New ACCampos() {New ACCampos("TIPOS_Codigo", "TIPOS_CodTipoDocumento")} _
                            , New ACCampos() {New ACCampos("TIPOS_DescCorta", "TIPOS_DocumentoCorto") _
                                              , New ACCampos("TIPOS_Descripcion", "TIPOS_Documento")}))
         '_join.Add(New ACJoin(ETipos.Esquema, ETipos.Tabla, "TCond", ACJoin.TipoJoin.Inner _
         '          , New ACCampos() {New ACCampos("TIPOS_Codigo", "TIPOS_CodCondicionPago")} _
         '          , New ACCampos() {New ACCampos("TIPOS_DescCorta", "TIPOS_CondicionPago") _
         '                            , New ACCampos("TIPOS_Descripcion", "TIPOS_CondicionPagoCorto")}))
         '_join.Add(New ACJoin(ETipos.Esquema, ETipos.Tabla, "TPag", ACJoin.TipoJoin.Inner _
         '          , New ACCampos() {New ACCampos("TIPOS_Codigo", "TIPOS_CodTipoPago")} _
         '          , New ACCampos() {New ACCampos("TIPOS_DescCorta", "TIPOS_TipoPago") _
         '                            , New ACCampos("TIPOS_Descripcion", "TIPOS_TipoPago")}))
         'If Not x_todos Then _where.Add("DOCVE_Estado", New ACWhere(EVENT_Pedidos.getEstado(EVENT_Pedidos.Estado.Ingresado), "Vent", "System.String", ACWhere.TipoWhere.Igual))
      Catch ex As Exception
         Throw ex
      End Try
   End Sub

   Public Function GrabarPagos(ByVal x_usuario As String, ByVal m_tipopago As ETipos.TipoDePago, ByVal x_serie As String, _
                               ByVal x_fecha As DateTime, ByVal x_tipocambio As Decimal)
      Try
         DAEnterprise.BeginTransaction()
         Dim _i As Integer = 1
         Dim _numero As Integer = getNroTransaccion(m_pvent_id, x_serie)
         Dim _codigo As String = String.Format("{0:00}{1}{2:0000000}", m_pvent_id, x_serie, _numero)
         Dim _entid_Codigo As String = ""
         For Each item As EVENT_DocsVenta In m_listVENT_PagosFacturas
            Dim _caja As New BTESO_Caja
            _caja.TESO_Caja = item.TESO_Caja
            _caja.TESO_Caja.Instanciar(ACEInstancia.Nuevo)
            _caja.TESO_Caja.TIPOS_CodTipoMoneda = item.TIPOS_CodTipoMoneda
            _caja.TESO_Caja.TIPOS_CodTransaccion = ETipos.getTipoDePago(m_tipopago)
            _caja.TESO_Caja.CAJA_OrdenDocumento = _i
            _caja.TESO_Caja.CAJA_Pase = ACEVentas.Constantes.GetPase(ACEVentas.Constantes.Pase.Entrada)
            _caja.TESO_Caja.CAJA_NroDocumento = item.DOCVE_Codigo
            _caja.TESO_Caja.CAJA_Fecha = x_fecha.Date
            _caja.TESO_Caja.CAJA_Codigo = _codigo
            _caja.TESO_Caja.CAJA_Serie = x_serie
            _caja.TESO_Caja.CAJA_Numero = _numero
            _caja.TESO_Caja.TIPOS_CodTipoDocumento = item.TIPOS_CodTipoDocumento

            _caja.TESO_Caja.CAJA_Glosa = IIf(m_tipopago = ETipos.TipoDePago.Efectivo, ACEVentas.Constantes.getGlosaTipoDePago(ETipos.TipoDePago.Efectivo), _
                                             ACEVentas.Constantes.getGlosaTipoDePago(m_tipopago)) & " - " & String.Format("{0}-{1:00000000}", item.DOCVE_Serie, item.DOCVE_Numero)
            _caja.TESO_Caja.CAJA_Importe = item.ImportePagar
            _caja.TESO_Caja.CAJA_ImporteVenta = item.DOCVE_TotalPagar
            _caja.TESO_Caja.ENTID_Codigo = item.ENTID_CodigoCliente
            _entid_Codigo = item.ENTID_CodigoCliente
            _caja.TESO_Caja.CAJA_Estado = ETESO_Caja.getEstado(ETESO_Caja.Estado.Ingresado)
            _caja.TESO_Caja.TIPOS_CodTipoOrigen = ETipos.getTipoOrigen(ETipos.OrigenCancelacion.CFacturas)
            _caja.TESO_Caja.CAJA_TCDocumento = x_tipocambio
            _caja.TESO_Caja.CAJA_TCOficinaVenta = m_tipocambiooficina.TIPOC_VentaOficina
            _caja.TESO_Caja.CAJA_TCPorUsuario = IIf(x_tipocambio = m_tipocambiosunat.TIPOC_VentaSunat, False, True)
            _caja.TESO_Caja.CAJA_TCSunatVenta = m_tipocambiosunat.TIPOC_VentaSunat
            _caja.TESO_Caja.CAJA_TCambio = m_tipocambiooficina.TIPOC_VentaOficina
            _caja.TESO_Caja.PVENT_Id = m_pvent_id
            Dim _whereCaja As New Hashtable : _whereCaja.Add("PVENT_Id", New ACWhere(_caja.TESO_Caja.PVENT_Id))
            _caja.TESO_Caja.CAJA_Id = _caja.getCorrelativo("CAJA_Id", _whereCaja)
            _i += 1
            _caja.Guardar(x_usuario, New String() {"CAJA_FechaPago"})
         Next

         Select Case m_tipopago
            Case ETipos.TipoDePago.DepositoBancario
               Dim _bteso_docspagos As New BTESO_DocsPagos(m_pvent_id, m_periodo, m_zonas_codigo, m_sucur_id)
               Dim i As Integer = 1
               For Each item As ETESO_DocsPagos In m_listteso_docspagos
                  _bteso_docspagos.TESO_DocsPagos = item
                  _bteso_docspagos.TESO_DocsPagos.ENTID_Codigo = _entid_Codigo
                  Dim _dpago_id As Integer = _bteso_docspagos.TESO_DocsPagos.DPAGO_Id
                  If _bteso_docspagos.TESO_DocsPagos.DPAGO_Id = 0 Then
                     _bteso_docspagos.TESO_DocsPagos.PVENT_Id = m_pvent_id
                     Dim _whereCaja As New Hashtable : _whereCaja.Add("PVENT_Id", New ACWhere(_bteso_docspagos.TESO_DocsPagos.PVENT_Id))
                     _dpago_id = _bteso_docspagos.getCorrelativo("DPAGO_Id", _whereCaja)
                     _bteso_docspagos.TESO_DocsPagos.DPAGO_Id = _dpago_id

                     Dim _whereNroDeposito As New Hashtable
                     _whereNroDeposito.Add("DPAGO_Numero", New ACWhere(_bteso_docspagos.TESO_DocsPagos.DPAGO_Numero))
                     _whereNroDeposito.Add("CUENT_Id", New ACWhere(_bteso_docspagos.TESO_DocsPagos.CUENT_Id))
                     _whereNroDeposito.Add("BANCO_Id", New ACWhere(_bteso_docspagos.TESO_DocsPagos.BANCO_Id))
                     Dim _bteso_dp As New BTESO_DocsPagos(m_pvent_id, m_periodo, m_zonas_codigo, m_sucur_id)
                     If _bteso_dp.Cargar(_whereNroDeposito) Then
                        Throw New Exception("El Documento con el que desea cancelar ya fue ingresado, en el mismo Banco, misma cuenta, y el mismo numero, revise el numero del documento y vuelva a intentarlo")
                     End If

                     If _bteso_docspagos.Guardar(x_usuario) Then
                        Dim _bteso_cajadocspago As New BTESO_CajaDocsPago
                        _bteso_cajadocspago.TESO_CajaDocsPago = New ETESO_CajaDocsPago
                        _bteso_cajadocspago.TESO_CajaDocsPago.Instanciar(ACEInstancia.Nuevo)
                        _bteso_cajadocspago.TESO_CajaDocsPago.PVENT_Id = m_pvent_id
                        _bteso_cajadocspago.TESO_CajaDocsPago.CAJA_Codigo = _codigo
                        _bteso_cajadocspago.TESO_CajaDocsPago.DPAGO_Id = _dpago_id
                        _bteso_cajadocspago.TESO_CajaDocsPago.CDEPO_Importe = item.DPAGO_Importe
                        _bteso_cajadocspago.TESO_CajaDocsPago.CDEPO_Numero = i
                        _bteso_cajadocspago.Guardar(x_usuario)
                        i += 1
                     End If
                  Else
                     Dim _bteso_cajadocspago As New BTESO_CajaDocsPago
                     _bteso_cajadocspago.TESO_CajaDocsPago = New ETESO_CajaDocsPago
                     _bteso_cajadocspago.TESO_CajaDocsPago.Instanciar(ACEInstancia.Nuevo)
                     _bteso_cajadocspago.TESO_CajaDocsPago.PVENT_Id = m_pvent_id
                     _bteso_cajadocspago.TESO_CajaDocsPago.CAJA_Codigo = _codigo
                     _bteso_cajadocspago.TESO_CajaDocsPago.DPAGO_Id = _dpago_id
                     _bteso_cajadocspago.TESO_CajaDocsPago.CDEPO_Importe = item.DPAGO_Importe
                     _bteso_cajadocspago.TESO_CajaDocsPago.CDEPO_Numero = i
                     _bteso_cajadocspago.Guardar(x_usuario)
                     i += 1
                  End If
               Next

            Case ETipos.TipoDePago.Detraccion
               Dim _bteso_docspagos As New BTESO_DocsPagos(m_pvent_id, m_periodo, m_zonas_codigo, m_sucur_id)
               Dim i As Integer = 1
               For Each item As ETESO_DocsPagos In m_listteso_docspagos
                  _bteso_docspagos.TESO_DocsPagos = item
                  _bteso_docspagos.TESO_DocsPagos.ENTID_Codigo = _entid_Codigo
                  _bteso_docspagos.TESO_DocsPagos.PVENT_Id = m_pvent_id
                  Dim _dpago_id As Integer = _bteso_docspagos.TESO_DocsPagos.DPAGO_Id
                  If _bteso_docspagos.TESO_DocsPagos.DPAGO_Id = 0 Then
                     Dim _whereCaja As New Hashtable : _whereCaja.Add("PVENT_Id", New ACWhere(_bteso_docspagos.TESO_DocsPagos.PVENT_Id))
                     _dpago_id = _bteso_docspagos.getCorrelativo("DPAGO_Id", _whereCaja)
                     _bteso_docspagos.TESO_DocsPagos.DPAGO_Id = _dpago_id

                     Dim _whereNroDeposito As New Hashtable
                     _whereNroDeposito.Add("DPAGO_Numero", New ACWhere(_bteso_docspagos.TESO_DocsPagos.DPAGO_Numero))
                     _whereNroDeposito.Add("CUENT_Id", New ACWhere(_bteso_docspagos.TESO_DocsPagos.CUENT_Id))
                     _whereNroDeposito.Add("BANCO_Id", New ACWhere(_bteso_docspagos.TESO_DocsPagos.BANCO_Id))
                     Dim _bteso_dp As New BTESO_DocsPagos(m_pvent_id, m_periodo, m_zonas_codigo, m_sucur_id)
                     If _bteso_dp.Cargar(_whereNroDeposito) Then
                        Throw New Exception("El Documento con el que desea cancelar ya fue ingresado, en el mismo Banco, misma cuenta, y el mismo numero, revise el numero del documento y vuelva a intentarlo")
                     End If

                     If _bteso_docspagos.Guardar(x_usuario) Then
                        Dim _bteso_cajadocspago As New BTESO_CajaDocsPago
                        _bteso_cajadocspago.TESO_CajaDocsPago = New ETESO_CajaDocsPago
                        _bteso_cajadocspago.TESO_CajaDocsPago.Instanciar(ACEInstancia.Nuevo)
                        _bteso_cajadocspago.TESO_CajaDocsPago.PVENT_Id = m_pvent_id
                        _bteso_cajadocspago.TESO_CajaDocsPago.CAJA_Codigo = _codigo
                        _bteso_cajadocspago.TESO_CajaDocsPago.DPAGO_Id = _dpago_id
                        _bteso_cajadocspago.TESO_CajaDocsPago.CDEPO_Importe = item.ImporteUsado
                        _bteso_cajadocspago.TESO_CajaDocsPago.CDEPO_Numero = i
                        '_bteso_cajadocspago.TESO_CajaDocsPago.CAJA_Id = item.
                        _bteso_cajadocspago.Guardar(x_usuario)
                        i += 1
                     End If
                  Else
                     Dim _bteso_cajadocspago As New BTESO_CajaDocsPago
                     _bteso_cajadocspago.TESO_CajaDocsPago = New ETESO_CajaDocsPago
                     _bteso_cajadocspago.TESO_CajaDocsPago.Instanciar(ACEInstancia.Nuevo)
                     _bteso_cajadocspago.TESO_CajaDocsPago.PVENT_Id = m_pvent_id
                     _bteso_cajadocspago.TESO_CajaDocsPago.CAJA_Codigo = _codigo
                     _bteso_cajadocspago.TESO_CajaDocsPago.DPAGO_Id = _dpago_id
                     _bteso_cajadocspago.TESO_CajaDocsPago.CDEPO_Importe = item.DPAGO_Importe
                     _bteso_cajadocspago.TESO_CajaDocsPago.CDEPO_Numero = i
                     '_bteso_cajadocspago.TESO_CajaDocsPago.CAJA_Id = item.
                     _bteso_cajadocspago.Guardar(x_usuario)
                     i += 1
                  End If

               Next
            Case ETipos.TipoDePago.NotaCredito
               '' Grabar Documentos que Pagan
               Dim _bteso_docspagos As New BTESO_DocsPagos(m_pvent_id, m_periodo, m_zonas_codigo, m_sucur_id)
               Dim i As Integer = 1
               For Each item As ETESO_DocsPagos In m_listteso_docspagos
                  _bteso_docspagos.TESO_DocsPagos = item
                  _bteso_docspagos.TESO_DocsPagos.ENTID_Codigo = _entid_Codigo
                  _bteso_docspagos.TESO_DocsPagos.DPAGO_Numero = String.Format("NC {0}-{1:0000000}", _bteso_docspagos.TESO_DocsPagos.VENT_DocsVenta.DOCVE_Serie, _bteso_docspagos.TESO_DocsPagos.VENT_DocsVenta.DOCVE_Numero)
                  _bteso_docspagos.TESO_DocsPagos.PVENT_Id = m_pvent_id
                  Dim _whereCaja As New Hashtable : _whereCaja.Add("PVENT_Id", New ACWhere(_bteso_docspagos.TESO_DocsPagos.PVENT_Id))
                  _bteso_docspagos.TESO_DocsPagos.DPAGO_Id = _bteso_docspagos.getCorrelativo("DPAGO_Id", _whereCaja)
                  If _bteso_docspagos.Guardar(x_usuario) Then
                     Dim _bteso_cajadocspago As New BTESO_CajaDocsPago
                     _bteso_cajadocspago.TESO_CajaDocsPago = New ETESO_CajaDocsPago
                     _bteso_cajadocspago.TESO_CajaDocsPago.Instanciar(ACEInstancia.Nuevo)
                     _bteso_cajadocspago.TESO_CajaDocsPago.PVENT_Id = m_pvent_id
                     _bteso_cajadocspago.TESO_CajaDocsPago.CAJA_Codigo = _codigo
                     _bteso_cajadocspago.TESO_CajaDocsPago.DPAGO_Id = _bteso_docspagos.TESO_DocsPagos.DPAGO_Id
                     _bteso_cajadocspago.TESO_CajaDocsPago.CDEPO_Importe = item.ImporteUsado
                     _bteso_cajadocspago.TESO_CajaDocsPago.CDEPO_Numero = i
                     _bteso_cajadocspago.Guardar(x_usuario)
                     i += 1
                  End If
                  '' Grabar Nota de Credito
                  _bteso_docspagos.TESO_DocsPagos.VENT_DocsVenta.ENTID_CodigoCliente = _entid_Codigo
                  Dim m_bgenerardocsventa As New BGenerarDocsVenta(m_pvent_id, m_periodo, m_zonas_codigo, m_sucur_id)
                  Dim x_msg As String = ""
                  m_bgenerardocsventa.VENT_DocsVenta = _bteso_docspagos.TESO_DocsPagos.VENT_DocsVenta
                  m_bgenerardocsventa.VENT_DocsVenta.Instanciar(ACEInstancia.Nuevo)
                  m_bgenerardocsventa.VENT_DocsVenta.DOCVE_Estado = EVENT_DocsVenta.getEstado(EVENT_DocsVenta.Estado.Ingresado)
                  m_bgenerardocsventa.VENT_DocsVenta.ListVENT_DocsVentaDetalle = New List(Of EVENT_DocsVentaDetalle)
                  Dim _detalle As New EVENT_DocsVentaDetalle
                  _detalle.DOCVD_PrecioUnitario = m_bgenerardocsventa.VENT_DocsVenta.DOCVE_ImporteVenta
                  _detalle.DOCVD_SubImporteVenta = m_bgenerardocsventa.VENT_DocsVenta.DOCVE_ImporteVenta
                  _detalle.DOCVD_Cantidad = 1
                  m_bgenerardocsventa.VENT_DocsVenta.ListVENT_DocsVentaDetalle.Add(_detalle)
                  If Not m_bgenerardocsventa.generarDocumento(x_usuario, m_bgenerardocsventa.VENT_DocsVenta.DOCVE_FechaDocumento, _
                                                          m_bgenerardocsventa.VENT_DocsVenta.DOCVE_Serie, _
                                                          m_bgenerardocsventa.VENT_DocsVenta.DOCVE_Numero, "E", x_msg, False) Then
                     Throw New Exception("No Se puede Generar el Documento Nota de Credito")
                  End If
               Next
            Case ETipos.TipoDePago.RecEgreInterno
               Dim _bteso_docspagos As New BTESO_DocsPagos(m_pvent_id, m_periodo, m_zonas_codigo, m_sucur_id)
               Dim i As Integer = 1
               For Each item As ETESO_DocsPagos In m_listteso_docspagos
                  _bteso_docspagos.TESO_DocsPagos = item
                  _bteso_docspagos.TESO_DocsPagos.ENTID_Codigo = _entid_Codigo
                  _bteso_docspagos.TESO_DocsPagos.PVENT_Id = m_pvent_id
                  Dim _whereCaja As New Hashtable : _whereCaja.Add("PVENT_Id", New ACWhere(_bteso_docspagos.TESO_DocsPagos.PVENT_Id))
                  _bteso_docspagos.TESO_DocsPagos.DPAGO_Id = _bteso_docspagos.getCorrelativo("DPAGO_Id", _whereCaja)
                  If _bteso_docspagos.Guardar(x_usuario) Then
                     Dim _bteso_cajadocspago As New BTESO_CajaDocsPago
                     _bteso_cajadocspago.TESO_CajaDocsPago = New ETESO_CajaDocsPago
                     _bteso_cajadocspago.TESO_CajaDocsPago.Instanciar(ACEInstancia.Nuevo)
                     _bteso_cajadocspago.TESO_CajaDocsPago.CAJA_Codigo = _codigo
                     _bteso_cajadocspago.TESO_CajaDocsPago.DPAGO_Id = _bteso_docspagos.TESO_DocsPagos.DPAGO_Id
                     _bteso_cajadocspago.TESO_CajaDocsPago.CDEPO_Importe = item.ImporteUsado
                     _bteso_cajadocspago.TESO_CajaDocsPago.PVENT_Id = m_pvent_id
                     _bteso_cajadocspago.TESO_CajaDocsPago.CDEPO_Numero = i
                     _bteso_cajadocspago.Guardar(x_usuario)
                     i += 1
                  End If
               Next
         End Select
         DAEnterprise.CommitTransaction()
         Return True
      Catch ex As Exception
         DAEnterprise.RollBackTransaction()
         Throw ex
      End Try
   End Function
#End Region

End Class

