Imports System
Imports System.Data
Imports System.Collections.Generic

Imports ACETransporte
Imports ACDTransporte
Imports System.Configuration
Imports ACFramework
Imports DAConexion
Imports ACEVentas
Imports ACBVentas

Public Class BTRAN_Vehiculos

#Region " Variables "

#End Region

#Region " Constructores "

#End Region

#Region " Propiedades "

#End Region

#Region " Funciones para obtencion de datos "

#End Region

#Region " Metodos "
   Public Function Busqueda(ByVal x_cadena As String) As Boolean
      Dim d_tran_vehiculos As New DTRAN_Vehiculos()
      Try
         m_listTRAN_Vehiculos = New List(Of ETRAN_Vehiculos)()
         Return d_tran_vehiculos.VEHISS_Todos(m_listTRAN_Vehiculos, x_cadena)
      Catch ex As Exception
         Throw ex
      End Try
   End Function


   ''' <summary> 
   ''' Capa de Negocio: TRAN_VEHISS_BuscarVehiculos
   ''' </summary>
   ''' <param name="x_pvent_id">Parametro 1: </param> 
   ''' <param name="x_cadena">Parametro 2: </param> 
   ''' <param name="x_campo">Parametro 3: </param> 
   ''' <returns></returns> 
   ''' <remarks></remarks> 
   Public Function Busqueda(ByVal x_pvent_id As Long, ByVal x_cadena As String, ByVal x_campo As Short) As Boolean
      m_listTRAN_Vehiculos = New List(Of ETRAN_Vehiculos)
      Try
         Return d_tran_vehiculos.TRAN_VEHISS_BuscarVehiculos(m_listTRAN_Vehiculos, x_pvent_id, x_cadena, x_campo)
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   ''' <summary> 
   ''' Capa de Negocio: TRAN_VEHISS_BuscarVehiculo
   ''' </summary>
   ''' <param name="x_tconsulta">Parametro 1: </param> 
   ''' <param name="x_cadena">Parametro 2: </param> 
   ''' <returns></returns> 
   ''' <remarks></remarks> 
   Public Function Busqueda(ByVal x_tconsulta As Short, ByVal x_cadena As String) As Boolean
      m_listTRAN_Vehiculos = New List(Of ETRAN_Vehiculos)
      Try
         Return d_tran_vehiculos.TRAN_VEHISS_BuscarVehiculo(m_listTRAN_Vehiculos, x_tconsulta, x_cadena)
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function Cargar(ByVal x_vehic_id As Long, ByVal x_opcion As ETRAN_Vehiculos.Inicializacion) As Boolean
      Try
         Dim d_tran_vehiculos As New DTRAN_Vehiculos()
         m_tran_vehiculos = New ETRAN_Vehiculos()
         If (d_tran_vehiculos.TRAN_VEHICSS_UnReg(m_tran_vehiculos, x_vehic_id)) Then
            Select Case x_opcion
               Case ETRAN_Vehiculos.Inicializacion.Ranflas
                  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
                  '' Cargar los detalles de la ranfla
                  Dim x_tranranflas As New BTRAN_VehiculosRanflas()
                  'Dim _where As New Hashtable()
                  '_where.Add("VEHIC_Id", New ACWhere(x_vehic_id))
                  x_tranranflas.CargarTodos(x_vehic_id, True, True)
                  m_tran_vehiculos.ListATRAN_Ranflas = New List(Of ETRAN_VehiculosRanflas)(x_tranranflas.ListTRAN_VehiculosRanflas)
                  '' Cargar el Historial de la ranflas
                  Dim x_tranhranflas As New BTRAN_VehiculosRanflas()
                  x_tranhranflas.CargarTodos(x_vehic_id, True, False)
                  m_tran_vehiculos.ListTRAN_HRanflas = New List(Of ETRAN_VehiculosRanflas)(x_tranhranflas.ListTRAN_VehiculosRanflas)
                  '''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
               Case ETRAN_Vehiculos.Inicializacion.Mantenimiento

               Case ETRAN_Vehiculos.Inicializacion.Marca
                  Dim _tipo As New BTipos
                  If _tipo.Cargar(m_tran_vehiculos.TIPOS_CodMarca) Then
                     m_tran_vehiculos.TIPOS_Marca = _tipo.Tipos.TIPOS_Descripcion
                  End If
               Case Else

            End Select

            Return True
         Else
            Return False
         End If
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function Cargar(ByVal x_vehic_id As Long, ByVal x_detalle As Boolean) As Boolean
      Try
         Dim _join As New List(Of ACJoin)
         _join.Add(New ACJoin(EEntidades.Esquema, EEntidades.Tabla, ACJoin.TipoJoin.Left _
                              , New ACCampos() {New ACCampos("ENTID_Codigo", "ENTID_CodigoTransportista")} _
                              , New ACCampos() {New ACCampos("ENTID_RazonSocial", "ENTID_RazonSocial")}))
         _join.Add(New ACJoin(ETipos.Esquema, ETipos.Tabla, "TComb", ACJoin.TipoJoin.Left _
                              , New ACCampos() {New ACCampos("TIPOS_Codigo", "TIPOS_CodTipoCombustible")} _
                              , New ACCampos() {New ACCampos("TIPOS_Descripcion", "TIPOS_TipoCombustible")}))
         _join.Add(New ACJoin(ETipos.Esquema, ETipos.Tabla, "TVehi", ACJoin.TipoJoin.Inner _
                              , New ACCampos() {New ACCampos("TIPOS_Codigo", "TIPOS_CodTipoVehiculo")} _
                              , New ACCampos() {New ACCampos("TIPOS_Descripcion", "TIPOS_Vehiculo")}))
         _join.Add(New ACJoin(ETipos.Esquema, ETipos.Tabla, "TMar", ACJoin.TipoJoin.Inner _
                              , New ACCampos() {New ACCampos("TIPOS_Codigo", "TIPOS_CodMarca")} _
                              , New ACCampos() {New ACCampos("TIPOS_Descripcion", "TIPOS_Marca")}))

         Dim _where As New Hashtable()
         _where.Add("VEHIC_Id", New ACWhere(x_vehic_id))
         Return Cargar(_join, _where)
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function Cargar(ByVal x_vehic_placa As String, ByVal x_detalle As Boolean) As Boolean
      Try
         Dim _join As New List(Of ACJoin)
         _join.Add(New ACJoin(EEntidades.Esquema, EEntidades.Tabla, ACJoin.TipoJoin.Left _
                              , New ACCampos() {New ACCampos("ENTID_Codigo", "ENTID_CodigoTransportista")} _
                              , New ACCampos() {New ACCampos("ENTID_RazonSocial", "ENTID_RazonSocial")}))
         _join.Add(New ACJoin(ETipos.Esquema, ETipos.Tabla, "TComb", ACJoin.TipoJoin.Left _
                              , New ACCampos() {New ACCampos("TIPOS_Codigo", "TIPOS_CodTipoCombustible")} _
                              , New ACCampos() {New ACCampos("TIPOS_Descripcion", "TIPOS_TipoCombustible")}))
         _join.Add(New ACJoin(ETipos.Esquema, ETipos.Tabla, "TVehi", ACJoin.TipoJoin.Inner _
                              , New ACCampos() {New ACCampos("TIPOS_Codigo", "TIPOS_CodTipoVehiculo")} _
                              , New ACCampos() {New ACCampos("TIPOS_Descripcion", "TIPOS_Vehiculo")}))
         _join.Add(New ACJoin(ETipos.Esquema, ETipos.Tabla, "TMar", ACJoin.TipoJoin.Inner _
                              , New ACCampos() {New ACCampos("TIPOS_Codigo", "TIPOS_CodMarca")} _
                              , New ACCampos() {New ACCampos("TIPOS_Descripcion", "TIPOS_Marca")}))

         Dim _where As New Hashtable()
         _where.Add("VEHIC_Placa", New ACWhere(x_vehic_placa))
         Return Cargar(_join, _where)
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function Cargar(ByVal x_opcion As ETRAN_Vehiculos.Inicializacion) As Boolean
      Dim x_vehic_id As Long
      Try
         x_vehic_id = m_tran_vehiculos.VEHIC_Id
         Select Case x_opcion
            Case ETRAN_Vehiculos.Inicializacion.Ranflas
               ''***************************************************************************************************
               '' Cargar los detalles de la ranfla
               Dim x_tranranflas As New BTRAN_VehiculosRanflas()
               x_tranranflas.CargarTodos(x_vehic_id, True, True)
               m_tran_vehiculos.ListATRAN_Ranflas = New List(Of ETRAN_VehiculosRanflas)(x_tranranflas.ListTRAN_VehiculosRanflas)
               '' Cargar el Historial de la ranflas
               Dim x_htran_vehiculosranflas As New BTRAN_VehiculosRanflas()
               x_htran_vehiculosranflas.CargarTodos(x_vehic_id, True, False)
               m_tran_vehiculos.ListTRAN_HRanflas = New List(Of ETRAN_VehiculosRanflas)(x_htran_vehiculosranflas.ListTRAN_VehiculosRanflas)
               ''***************************************************************************************************
            Case ETRAN_Vehiculos.Inicializacion.Mantenimiento
               ''***************************************************************************************************
               Dim x_tran_vehiculosmantenimiento As New BTRAN_VehiculosMantenimiento()
               '' Crear Inner Join Con otras Tablas
               Dim _join As New List(Of ACJoin)
               _join.Add(New ACJoin("dbo", "Tipos", ACFramework.ACJoin.TipoJoin.Inner _
                                  , New ACCampos() {New ACCampos("TIPOS_Codigo", "TIPOS_CodTipoMantenimiento")} _
                                  , New ACCampos() {New ACCampos("TIPOS_Descripcion", "TIPOS_TipoMantenimiento")}))
               '' 
               _join.Add(New ACJoin("dbo", "Entidades", ACJoin.TipoJoin.Inner _
                                  , New ACCampos() {New ACCampos("ENTID_Codigo", "ENTID_Codigo")} _
                                  , New ACCampos() {New ACCampos("ENTID_RazonSocial", "ENTID_RazonSocial")}))

               Dim _where As New Hashtable()
               _where.Add("VEHIC_Id", New ACFramework.ACWhere(x_vehic_id, ACFramework.ACWhere.TipoWhere.Igual))
               x_tran_vehiculosmantenimiento.CargarTodos(_join, _where)

               m_tran_vehiculos.ListVMantenimiento = New List(Of ETRAN_VehiculosMantenimiento)(x_tran_vehiculosmantenimiento.ListTRAN_VehiculosMantenimiento)
               ''***************************************************************************************************
            Case ETRAN_Vehiculos.Inicializacion.Combustible
               ''***************************************************************************************************
               Dim x_tran_combustibleconsumo As New BTRAN_CombustibleConsumo()
               '' Crear Inner Join Con otras Tablas
               Dim _join As New List(Of ACFramework.ACJoin)
               _join.Add(New ACJoin("dbo", "Tipos", "TCom", ACJoin.TipoJoin.Left _
                                  , New ACCampos() {New ACCampos("TIPOS_Codigo", "TIPOS_CodTipoCombustible")} _
                                  , New ACCampos() {New ACCampos("TIPOS_Descripcion", "TIPOS_TipoCombustible")}))
               _join.Add(New ACJoin("dbo", "Tipos", "TMPag", ACJoin.TipoJoin.Left _
                                  , New ACCampos() {New ACCampos("TIPOS_Codigo", "TIPOS_CodModoPago")} _
                                  , New ACCampos() {New ACCampos("TIPOS_Descripcion", "TIPOS_ModoPago")}))
               Dim _where As New Hashtable()
               _where.Add("VEHIC_Id", New ACFramework.ACWhere(x_vehic_id, ACFramework.ACWhere.TipoWhere.Igual))
               x_tran_combustibleconsumo.CargarTodos(_join, _where)

               m_tran_vehiculos.ListVConCombustible = New List(Of ETRAN_CombustibleConsumo)(x_tran_combustibleconsumo.ListTRAN_CombustibleConsumo)
               ''***************************************************************************************************
            Case ETRAN_Vehiculos.Inicializacion.Incidencias
               ''***************************************************************************************************
               Dim x_incidenciavehiculos As New BTRAN_VehiculosIncidencias()
               '' Crear Inner Join Con otras Tablas
               Dim _join As New List(Of ACFramework.ACJoin)
               _join.Add(New ACFramework.ACJoin("dbo", "Tipos", "TCom", ACFramework.ACJoin.TipoJoin.Inner _
                                              , New ACCampos() {New ACCampos("TIPOS_Codigo", "TIPOS_CODTIPOINCIDENCIA")} _
                                              , New ACCampos() {New ACCampos("TIPOS_Descripcion", "TIPOS_TipoIncidencia")}))

               Dim _where As New Hashtable()
               _where.Add("VEHIC_Id", New ACFramework.ACWhere(x_vehic_id, ACFramework.ACWhere.TipoWhere.Igual))
               x_incidenciavehiculos.CargarTodos(_join, _where)

               m_tran_vehiculos.ListVIncidencias = New List(Of ETRAN_VehiculosIncidencias)(x_incidenciavehiculos.ListTRAN_VehiculosIncidencias)
               ''***************************************************************************************************
            Case ETRAN_Vehiculos.Inicializacion.Seguros
               ''***************************************************************************************************
               Dim x_segurosvehiculos As New BTRAN_VehiculosSeguros()
               '' Crear Inner Join Con otras Tablas
               Dim _where As New Hashtable()
               _where.Add("VEHIC_Id", New ACFramework.ACWhere(x_vehic_id, ACFramework.ACWhere.TipoWhere.Igual))
               x_segurosvehiculos.CargarTodos(_where)

               m_tran_vehiculos.ListVSeguros = New List(Of ETRAN_VehiculosSeguros)(x_segurosvehiculos.ListTRAN_VehiculosSeguros)
               ''***************************************************************************************************
            Case ETRAN_Vehiculos.Inicializacion.Conductores
               ''***************************************************************************************************
               Dim x_tran_vehiculosconductores As New BTRAN_VehiculosConductores()
               x_tran_vehiculosconductores.CargarTodos(x_vehic_id, True, True, EEntidades.TipoEntidad.Conductores)
               m_tran_vehiculos.ListATRAN_Conductores = New List(Of ETRAN_VehiculosConductores)(x_tran_vehiculosconductores.ListTRAN_VehiculosConductores)
               '' Cargar el Historial de la ranflas
               Dim x_htran_vehiculosconductores As New BTRAN_VehiculosConductores()
               x_htran_vehiculosconductores.CargarTodos(x_vehic_id, True, False, EEntidades.TipoEntidad.Conductores)
               m_tran_vehiculos.ListTRAN_HConductores = New List(Of ETRAN_VehiculosConductores)(x_htran_vehiculosconductores.ListTRAN_VehiculosConductores)
               ''***************************************************************************************************
            Case Else
               Cargar(ETRAN_Vehiculos.Inicializacion.Ranflas)
         End Select
         Return True
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function Ayuda(ByVal x_cadena As String, ByVal x_opcion As Short) As Boolean
      Dim d_tran_vehiculos As New DTRAN_Vehiculos()
      Try
         m_dtTRAN_Vehiculos = New DataTable()
         Return d_tran_vehiculos.TRAN_VEHICSS_Ayuda(m_dtTRAN_Vehiculos, x_cadena, x_opcion)
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function Ayuda(ByVal x_where As Hashtable) As Boolean
      Dim d_tran_vehiculos As New DTRAN_Vehiculos()
      Try
         m_dtTRAN_Vehiculos = New DataTable()
         Return d_tran_vehiculos.VEHISS_TodosAyuda(m_dtTRAN_Vehiculos, x_where)
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function Guardar(ByVal x_usuario As String, ByVal x_detalle As Boolean) As Boolean
      Try
         If x_detalle Then
            Dim d_tran_vehiculos As New DTRAN_Vehiculos()
            If m_tran_vehiculos.Nuevo Then
               DAEnterprise.BeginTransaction()
               Dim b_correlativo As New BCorrelativos()
               Try
                  m_tran_vehiculos.VEHIC_EstadoViaje = BConstantes.getEstado(BConstantes.EstadosVehiculoViaje.Disponible)
                  b_correlativo.getCorrelativo(BConstantes.SUCUR_Id, ECorrelativos.NTabla.TRAN_Vehiculos)
                  m_tran_vehiculos.VEHIC_Codigo = b_correlativo.Correlativos.Codigo
                  d_tran_vehiculos.TRAN_VEHICSI_UnReg(m_tran_vehiculos, x_usuario)
                  b_correlativo.Correlativos.ZONAS_Codigo = BConstantes.ZONAS_Codigo
                  b_correlativo.SetCorrelativo(x_usuario)
                  DAEnterprise.CommitTransaction()
               Catch ex As Exception
                  DAEnterprise.RollBackTransaction()
                  Throw ex
               End Try
            ElseIf m_tran_vehiculos.Modificado Then
               d_tran_vehiculos.TRAN_VEHICSU_UnReg(m_tran_vehiculos, x_usuario)
            ElseIf m_tran_vehiculos.Eliminado Then
               d_tran_vehiculos.TRAN_VEHICSD_UnReg(m_tran_vehiculos)
            End If
            Return True
         Else
            Return Guardar(x_usuario)
         End If
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function Ayuda(ByVal x_cadena As String, ByVal x_campo As String) As Boolean
      Dim d_tran_vehiculos As New DTRAN_Vehiculos()
      Dim x_where As New Hashtable
      Try
         x_where.Add(x_campo, New ACWhere(x_cadena, ACWhere.TipoWhere._Like))
         m_dtTRAN_Vehiculos = New DataTable()
         Return d_tran_vehiculos.VEHISS_TodosAyuda(m_dtTRAN_Vehiculos, x_where)
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   Public Function Ayuda(ByVal x_entid_codigo As String, ByVal x_cadena As String, ByVal x_campo As String) As Boolean
      Dim d_tran_vehiculos As New DTRAN_Vehiculos()
      Dim x_where As New Hashtable
      Try
         x_where.Add(x_campo, New ACWhere(x_cadena, ACWhere.TipoWhere._Like))
         x_where.Add("ENTID_CodigoTransportista", New ACWhere(x_entid_codigo, ACWhere.TipoWhere.Igual))
         m_dtTRAN_Vehiculos = New DataTable()
         Return d_tran_vehiculos.VEHISS_TodosAyuda(m_dtTRAN_Vehiculos, x_where)
      Catch ex As Exception
         Throw ex
      End Try
   End Function

   ''' <summary> 
   ''' Capa de Negocio: TRAN_ObtenerModelosVehiculos
   ''' </summary> 
   ''' <param name="x_pvent_id">Parametro 1: </param> 
   ''' <returns></returns> 
   ''' <remarks></remarks> 
   Public Function TRAN_ObtenerModelosVehiculos(ByVal x_pvent_id As Long) As Boolean
      Try
         Return d_tran_vehiculos.TRAN_ObtenerModelosVehiculos(m_dtTRAN_Vehiculos, x_pvent_id)
      Catch ex As Exception
         Throw ex
      End Try
   End Function

#End Region

End Class

